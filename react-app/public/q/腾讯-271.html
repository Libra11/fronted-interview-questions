<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>[Vue] Vue3 çš„å“åº”å¼åŸç†? - é¢è¯•é¢˜åˆ·é¢˜</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <meta name="description" content="&lt;h3&gt;è¯¥è¯é¢˜æ¶‰åŠçš„ç›¸å…³å†…å®¹&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;åŸç†ï¼šProxyã€trackã€trigger&lt;/li&gt;&lt;li&gt;æ–°å¢å±æ€§&lt;/li&gt;&lt;li&gt;éå†åæ–°å¢&lt;/li&gt;&lt;li&gt;éå†ååˆ é™¤æˆ–è€…æ¸…ç©º&lt;/li&gt;&lt;li&gt;è·å– keys&lt;/li&gt;&lt;li&gt;åˆ é™¤å¯¹è±¡å±æ€§&lt;/li&gt;&lt;li&gt;åˆ¤æ–­å±æ€§æ˜¯å¦" />
  <link rel="icon" href="../assets/favicon.svg" />
  <style>.content a{color:var(--brand);} .content img{max-width:100%;}</style>
  
  <!-- Open Graph -->
  <meta property="og:title" content="[Vue] Vue3 çš„å“åº”å¼åŸç†?" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="&lt;h3&gt;è¯¥è¯é¢˜æ¶‰åŠçš„ç›¸å…³å†…å®¹&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;åŸç†ï¼šProxyã€trackã€trigger&lt;/li&gt;&lt;li&gt;æ–°å¢å±æ€§&lt;/li&gt;&lt;li&gt;éå†åæ–°å¢&lt;/li&gt;&lt;li&gt;éå†ååˆ é™¤æˆ–è€…æ¸…ç©º&lt;/li&gt;&lt;li&gt;è·å– keys&lt;/li&gt;&lt;li&gt;åˆ é™¤å¯¹è±¡å±æ€§&lt;/li&gt;&lt;li&gt;åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨&lt;/li&gt;&lt;li&gt;æ€§èƒ½&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;æ¨èé˜…è¯»æ–‡æ¡£ï¼š https://juejin.cn/post/684" />
  <meta property="og:locale" content="zh_CN" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="../index.html">é¢è¯•é¢˜åˆ·é¢˜</a>
      <nav class="nav">
        <a href="../index.html">é¦–é¡µ</a>
        <a href="../index.html#categories">åˆ†ç±»</a>
        <a href="https://github.com/pro-collection/interview-question/issues/271" target="_blank" rel="noopener">åŸå§‹é“¾æ¥</a>
      </nav>
    </div>
  </header>
  <main class="container article">
    <div class="article-head">
      <a class="back" href="../index.html">â† è¿”å›åˆ—è¡¨</a>
      <h1>[Vue] Vue3 çš„å“åº”å¼åŸç†?</h1>
      <div class="subtitle">è…¾è®¯ Â· webæ¡†æ¶ Â· è…¾è®¯</div>
      <div class="meta">åˆ›å»ºï¼š2023-04-09T07:02:57Z Â· æ›´æ–°ï¼š2023-04-09T07:02:58Z</div>
    </div>
    <article class="content markdown-body"><h3>è¯¥è¯é¢˜æ¶‰åŠçš„ç›¸å…³å†…å®¹</h3><ul><li>åŸç†ï¼šProxyã€trackã€trigger</li><li>æ–°å¢å±æ€§</li><li>éå†åæ–°å¢</li><li>éå†ååˆ é™¤æˆ–è€…æ¸…ç©º</li><li>è·å– keys</li><li>åˆ é™¤å¯¹è±¡å±æ€§</li><li>åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨</li><li>æ€§èƒ½</li></ul><p>æ¨èé˜…è¯»æ–‡æ¡£ï¼š https://juejin.cn/post/6844904122479542285</p><h3>å“åº”å¼ä»“åº“</h3><p>Vue3 ä¸åŒäº Vue2 ä¹Ÿä½“ç°åœ¨æºç ç»“æ„ä¸Šï¼ŒVue3 æŠŠè€¦åˆæ€§æ¯”è¾ƒä½çš„åŒ…åˆ†æ•£åœ¨ <code>packages</code> ç›®å½•ä¸‹å•ç‹¬å‘å¸ƒæˆ <code>npm</code> åŒ…ã€‚ è¿™ä¹Ÿæ˜¯ç›®å‰å¾ˆæµè¡Œçš„ä¸€ç§å¤§å‹é¡¹ç›®ç®¡ç†æ–¹å¼ <code>Monorepo</code>ã€‚</p><p>å…¶ä¸­è´Ÿè´£å“åº”å¼éƒ¨åˆ†çš„ä»“åº“å°±æ˜¯ <code>@vue/reactivity</code>ï¼Œå®ƒä¸æ¶‰åŠ Vue çš„å…¶ä»–çš„ä»»ä½•éƒ¨åˆ†ï¼Œæ˜¯éå¸¸éå¸¸ ã€Œæ­£äº¤ã€ çš„ä¸€ç§å®ç°æ–¹å¼ã€‚</p><p>ç”šè‡³å¯ä»¥<code>è½»æ¾çš„é›†æˆè¿› React</code> https://juejin.cn/post/6844904095594381325</p><h3>åŒºåˆ«</h3><p>Proxy å’Œ Object.defineProperty çš„ä½¿ç”¨æ–¹æ³•çœ‹ä¼¼å¾ˆç›¸ä¼¼ï¼Œå…¶å® Proxy æ˜¯åœ¨ ã€Œæ›´é«˜ç»´åº¦ã€ ä¸Šå»æ‹¦æˆªå±æ€§çš„ä¿®æ”¹çš„ï¼Œæ€ä¹ˆç†è§£å‘¢ï¼Ÿ</p><p>Vue2 ä¸­ï¼Œå¯¹äºç»™å®šçš„ dataï¼Œå¦‚ <code>{ count: 1 }</code>ï¼Œæ˜¯éœ€è¦æ ¹æ®å…·ä½“çš„ key ä¹Ÿå°±æ˜¯ <code>count</code>ï¼Œå»å¯¹ã€Œä¿®æ”¹ data.count ã€ å’Œ ã€Œè¯»å– data.countã€è¿›è¡Œæ‹¦æˆªï¼Œä¹Ÿå°±æ˜¯</p><pre class="code-block"><code class="language-javascript">Object.defineProperty(data, &#39;count&#39;, {
  get() {},
  set() {},
})
</code></pre><p>å¿…é¡»é¢„å…ˆçŸ¥é“è¦æ‹¦æˆªçš„ key æ˜¯ä»€ä¹ˆï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ Vue2 é‡Œå¯¹äºå¯¹è±¡ä¸Šçš„æ–°å¢å±æ€§æ— èƒ½ä¸ºåŠ›ã€‚</p><p>è€Œ Vue3 æ‰€ä½¿ç”¨çš„ Proxyï¼Œåˆ™æ˜¯è¿™æ ·æ‹¦æˆªçš„ï¼š</p><pre class="code-block"><code class="language-javascript">new Proxy(data, {
  get(key) { },
  set(key, value) { },
})

</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æœ¬ä¸éœ€è¦å…³å¿ƒå…·ä½“çš„ keyï¼Œå®ƒå»æ‹¦æˆªçš„æ˜¯ ã€Œä¿®æ”¹ data ä¸Šçš„ä»»æ„ keyã€ å’Œ ã€Œè¯»å– data ä¸Šçš„ä»»æ„ keyã€ã€‚</p><p>æ‰€ä»¥ï¼Œä¸ç®¡æ˜¯å·²æœ‰çš„ key è¿˜æ˜¯æ–°å¢çš„ keyï¼Œéƒ½é€ƒä¸è¿‡å®ƒçš„é­”çˆªã€‚</p><p>ä½†æ˜¯ Proxy æ›´åŠ å¼ºå¤§çš„åœ°æ–¹è¿˜åœ¨äº Proxy é™¤äº† get å’Œ setï¼Œè¿˜å¯ä»¥æ‹¦æˆªæ›´å¤šçš„æ“ä½œç¬¦ã€‚</p><h3>ç®€å•çš„ä¾‹å­ğŸŒ°</h3><p>å…ˆå†™ä¸€ä¸ª Vue3 å“åº”å¼çš„æœ€å°æ¡ˆä¾‹ï¼Œæœ¬æ–‡çš„ç›¸å…³æ¡ˆä¾‹éƒ½åªä¼šç”¨ <code>reactive</code> å’Œ <code>effect</code> è¿™ä¸¤ä¸ª apiã€‚å¦‚æœä½ äº†è§£è¿‡ React ä¸­çš„ <code>useEffect</code>ï¼Œç›¸ä¿¡ä½ ä¼šå¯¹è¿™ä¸ªæ¦‚å¿µç§’æ‡‚ï¼ŒVue3 çš„ <code>effect</code> ä¸è¿‡å°±æ˜¯å»æ‰äº†æ‰‹åŠ¨å£°æ˜ä¾èµ–çš„ã€Œè¿›åŒ–ç‰ˆã€çš„ <code>useEffect</code>ã€‚</p><p>React ä¸­æ‰‹åŠ¨å£°æ˜ <code>[data.count]</code> è¿™ä¸ªä¾èµ–çš„æ­¥éª¤è¢« Vue3 å†…éƒ¨ç›´æ¥åšæ‰äº†ï¼Œåœ¨ <code>effect</code> å‡½æ•°å†…éƒ¨è¯»å–åˆ° <code>data.count</code> çš„æ—¶å€™ï¼Œå®ƒå°±å·²ç»è¢«æ”¶é›†ä½œä¸ºä¾èµ–äº†ã€‚</p><p>Vue3ï¼š</p><pre class="code-block"><code class="language-kotlin">// å“åº”å¼æ•°æ®
const data = reactive({
  count: 1
})

// è§‚æµ‹å˜åŒ–
effect(() =&gt; console.log(&#39;count changed&#39;, data.count))

// è§¦å‘ console.log(&#39;count changed&#39;, data.count) é‡æ–°æ‰§è¡Œ
data.count = 2

</code></pre><p>Reactï¼š</p><pre class="code-block"><code class="language-scss">// æ•°æ®
const [data, setData] = useState({
  count: 1
})

// è§‚æµ‹å˜åŒ– éœ€è¦æ‰‹åŠ¨å£°æ˜ä¾èµ–
useEffect(() =&gt; {
  console.log(&#39;count changed&#39;, data.count)
}, [data.count])

// è§¦å‘ console.log(&#39;count changed&#39;, data.count) é‡æ–°æ‰§è¡Œ
setData({
  count: 2
})

</code></pre><p>ä¹Ÿå¯ä»¥æŠŠ <code>effect</code> ä¸­çš„å›è°ƒå‡½æ•°è”æƒ³åˆ°è§†å›¾çš„é‡æ–°æ¸²æŸ“ã€ watch çš„å›è°ƒå‡½æ•°ç­‰ç­‰â€¦â€¦ å®ƒä»¬æ˜¯åŒæ ·åŸºäºè¿™å¥—å“åº”å¼æœºåˆ¶çš„ã€‚</p><p>è€Œæœ¬æ–‡çš„æ ¸å¿ƒç›®çš„ï¼Œå°±æ˜¯æ¢ç©¶è¿™ä¸ªåŸºäº Proxy çš„ reactive apiï¼Œåˆ°åº•èƒ½å¼ºå¤§åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Œèƒ½ç›‘å¬åˆ°ç”¨æˆ·å¯¹äºä»€ä¹ˆç¨‹åº¦çš„ä¿®æ”¹ã€‚</p><h3>è®²è®²åŸç†</h3><p>å…ˆæœ€å°åŒ–çš„è®²è§£ä¸€ä¸‹å“åº”å¼çš„åŸç†ï¼Œå…¶å®å°±æ˜¯åœ¨ Proxy ç¬¬äºŒä¸ªå‚æ•° <code>handler</code> ä¹Ÿå°±æ˜¯é™·é˜±æ“ä½œç¬¦ä¸­ï¼Œæ‹¦æˆªå„ç§å–å€¼ã€èµ‹å€¼æ“ä½œï¼Œä¾æ‰˜ <code>track</code> å’Œ <code>trigger</code> ä¸¤ä¸ªå‡½æ•°è¿›è¡Œä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°ã€‚</p><p><code>track</code> ç”¨æ¥åœ¨è¯»å–æ—¶æ”¶é›†ä¾èµ–ã€‚</p><p><code>trigger</code> ç”¨æ¥åœ¨æ›´æ–°æ—¶è§¦å‘ä¾èµ–ã€‚</p><h3>track</h3><pre class="code-block"><code class="language-vbnet">function track(target: object, type: TrackOpTypes, key: unknown) {
  const depsMap = targetMap.get(target);
  // æ”¶é›†ä¾èµ–æ—¶ é€šè¿‡ key å»ºç«‹ä¸€ä¸ª set
  let dep = new Set()
  targetMap.set(ITERATE_KEY, dep)
  // è¿™ä¸ª effect å¯ä»¥å…ˆç†è§£ä¸ºæ›´æ–°å‡½æ•° å­˜æ”¾åœ¨ dep é‡Œ
  dep.add(effect)
}

</code></pre><p><code>target</code> æ˜¯åŸå¯¹è±¡ã€‚</p><p><code>type</code> æ˜¯æœ¬æ¬¡æ”¶é›†çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯æ”¶é›†ä¾èµ–çš„æ—¶å€™ç”¨æ¥æ ‡è¯†æ˜¯ä»€ä¹ˆç±»å‹çš„æ“ä½œï¼Œæ¯”å¦‚ä¸Šæ–‡ä¾èµ–ä¸­çš„ç±»å‹å°±æ˜¯ <code>get</code>ï¼Œè¿™ä¸ªåç»­ä¼šè¯¦ç»†è®²è§£ã€‚</p><p><code>key</code> æ˜¯æŒ‡æœ¬æ¬¡è®¿é—®çš„æ˜¯æ•°æ®ä¸­çš„å“ªä¸ª keyï¼Œæ¯”å¦‚ä¸Šæ–‡ä¾‹å­ä¸­æ”¶é›†ä¾èµ–çš„ key å°±æ˜¯ <code>count</code></p><p>é¦–å…ˆå…¨å±€ä¼šå­˜åœ¨ä¸€ä¸ª <code>targetMap</code>ï¼Œå®ƒç”¨æ¥å»ºç«‹ <code>æ•°æ® -&gt; ä¾èµ–</code> çš„æ˜ å°„ï¼Œå®ƒæ˜¯ä¸€ä¸ª WeakMap æ•°æ®ç»“æ„ã€‚</p><p>è€Œ <code>targetMap</code> é€šè¿‡æ•°æ® <code>target</code>ï¼Œå¯ä»¥è·å–åˆ° <code>depsMap</code>ï¼Œå®ƒç”¨æ¥å­˜æ”¾è¿™ä¸ªæ•°æ®å¯¹åº”çš„æ‰€æœ‰å“åº”å¼ä¾èµ–ã€‚</p><p><code>depsMap</code> çš„æ¯ä¸€é¡¹åˆ™æ˜¯ä¸€ä¸ª Set æ•°æ®ç»“æ„ï¼Œè€Œè¿™ä¸ª Set å°±å­˜æ”¾ç€å¯¹åº” key çš„æ›´æ–°å‡½æ•°ã€‚</p><p>æ˜¯ä¸æ˜¯æœ‰ç‚¹ç»•ï¼Ÿæˆ‘ä»¬ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥ä¸¾ä¾‹å§ã€‚</p><pre class="code-block"><code class="language-ini">const target = { count: 1}
const data = reactive(target)

const effection = effect(() =&gt; {
  console.log(data.count)
})

</code></pre><p>å¯¹äºè¿™ä¸ªä¾‹å­çš„ä¾èµ–å…³ç³»ï¼Œ</p><ol><li>å…¨å±€çš„ <code>targetMap</code> æ˜¯ï¼š</li></ol><pre class="code-block"><code class="language-js">targetMap: {
  { count: 1 }: dep
}

</code></pre><ol><li>dep åˆ™æ˜¯</li></ol><pre class="code-block"><code class="language-js">dep: {
  count: Set { effection }
}

</code></pre><p>è¿™æ ·ä¸€å±‚å±‚çš„ä¸‹å»ï¼Œå°±å¯ä»¥é€šè¿‡ <code>target</code> æ‰¾åˆ° <code>count</code> å¯¹åº”çš„æ›´æ–°å‡½æ•° <code>effection</code> äº†ã€‚</p><h3>trigger</h3><p>è¿™é‡Œæ˜¯æœ€å°åŒ–çš„å®ç°ï¼Œä»…ä»…ä¸ºäº†ä¾¿äºç†è§£åŸç†ï¼Œå®é™…ä¸Šè¦å¤æ‚å¾ˆå¤šï¼Œ</p><p>å…¶å® <code>type</code> çš„ä½œç”¨å¾ˆå…³é”®ï¼Œå…ˆè®°ä½ï¼Œåé¢ä¼šè¯¦ç»†è®²ã€‚</p><pre class="code-block"><code class="language-typescript">export function trigger(
  target: object,
  type: TriggerOpTypes,
  key?: unknown,
) {
  // ç®€åŒ–æ¥è¯´ å°±æ˜¯é€šè¿‡ key æ‰¾åˆ°æ‰€æœ‰æ›´æ–°å‡½æ•° ä¾æ¬¡æ‰§è¡Œ
  const dep = targetMap.get(target)
  dep.get(key).forEach(effect =&gt; effect())
}
</code></pre></article>
  </main>
  <footer class="site-footer">Â© é¢è¯•é¢˜åˆ·é¢˜ Â· ç”±æœ¬åœ°é™æ€é¡µé¢ç”Ÿæˆ</footer>
</body>
</html>