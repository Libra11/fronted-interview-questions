# pnpm äº†è§£å¤šå°‘ï¼Ÿ

- Issue: #140
- State: open
- Labels: å·¥ç¨‹åŒ–
- Author: yanlele
- URL: https://github.com/pro-collection/interview-question/issues/140
- Created: 2023-03-21T16:03:46Z
- Updated: 2023-03-21T16:07:02Z

## Body

pnpmï¼Œè‹±æ–‡é‡Œé¢çš„æ„æ€å«åš `performant npm` ï¼Œæ„å‘³â€œé«˜æ€§èƒ½çš„ npmâ€ï¼Œå®˜ç½‘åœ°å€å¯ä»¥å‚è€ƒ [pnpm.io/ã€‚](https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2F%25E3%2580%2582 "https://pnpm.io/%E3%80%82")

pnpm ç›¸æ¯”è¾ƒäº yarn/npm è¿™ä¸¤ä¸ªå¸¸ç”¨çš„åŒ…ç®¡ç†å·¥å…·åœ¨æ€§èƒ½ä¸Šä¹Ÿæœ‰äº†æå¤§çš„æå‡ï¼Œæ ¹æ®ç›®å‰å®˜æ–¹æä¾›çš„ [benchmark](https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2Fbenchmarks "https://pnpm.io/benchmarks") æ•°æ®å¯ä»¥çœ‹å‡ºåœ¨ä¸€äº›ç»¼åˆåœºæ™¯ä¸‹æ¯” npm/yarn å¿«äº†å¤§æ¦‚ä¸¤å€ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa38fc979f4f4ed6a5ec4af64a73c34e~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå°†ä¼šä»‹ç»ä¸€äº›å…³äº pnpm åœ¨ä¾èµ–ç®¡ç†æ–¹é¢çš„ä¼˜åŒ–ï¼Œåœ¨ monorepo ä¸­ç›¸æ¯”è¾ƒäº yarn workspace çš„åº”ç”¨ï¼Œä»¥åŠä¹Ÿä¼šä»‹ç»ä¸€äº› pnpm ç›®å‰å­˜åœ¨çš„ä¸€äº›ç¼ºé™·ï¼ŒåŒ…æ‹¬è®¨è®ºä¸€ä¸‹æœªæ¥ pnpm ä¼šåšçš„ä¸€äº›äº‹æƒ…ã€‚

### ä¾èµ–ç®¡ç†

è¿™èŠ‚ä¼šé€šè¿‡ pnpm åœ¨ä¾èµ–ç®¡ç†è¿™ä¸€å—çš„ä¸€äº›ä¸åŒäºæ­£å¸¸åŒ…ç®¡ç†å·¥å…·çš„ä¸€äº›ä¼˜åŒ–æŠ€å·§ã€‚

#### hard link æœºåˆ¶

ä»‹ç» pnpm ä¸€å®šç¦»ä¸å¼€çš„å°±æ˜¯å…³äº pnpm åœ¨å®‰è£…ä¾èµ–æ–¹é¢åšçš„ä¸€äº›ä¼˜åŒ–ï¼Œæ ¹æ®å‰é¢çš„ benchmark å›¾å¯ä»¥çœ‹åˆ°å…¶æ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚

é‚£ä¹ˆ pnpm æ˜¯æ€ä¹ˆåšåˆ°å¦‚æ­¤å¤§çš„æå‡çš„å‘¢ï¼Ÿæ˜¯å› ä¸ºè®¡ç®—æœºé‡Œé¢ä¸€ä¸ªå«åš **[Hard link](https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FHard_link "https://en.wikipedia.org/wiki/Hard_link")** çš„æœºåˆ¶ï¼Œ`hard link` ä½¿å¾—ç”¨æˆ·å¯ä»¥é€šè¿‡ä¸åŒçš„è·¯å¾„å¼•ç”¨æ–¹å¼å»æ‰¾åˆ°æŸä¸ªæ–‡ä»¶ã€‚pnpm ä¼šåœ¨å…¨å±€çš„ store ç›®å½•é‡Œå­˜å‚¨é¡¹ç›® `node_modules` æ–‡ä»¶çš„ `hard links` ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œä¾‹å¦‚é¡¹ç›®é‡Œé¢æœ‰ä¸ª 1MB çš„ä¾èµ– aï¼Œåœ¨ pnpm ä¸­ï¼Œçœ‹ä¸Šå»è¿™ä¸ª a ä¾èµ–åŒæ—¶å ç”¨äº† 1MB çš„ node\_modules ç›®å½•ä»¥åŠå…¨å±€ store ç›®å½• 1MB çš„ç©ºé—´(åŠ èµ·æ¥æ˜¯ 2MB)ï¼Œä½†å› ä¸º `hard link` çš„æœºåˆ¶ä½¿å¾—ä¸¤ä¸ªç›®å½•ä¸‹ç›¸åŒçš„ 1MB ç©ºé—´èƒ½ä»ä¸¤ä¸ªä¸åŒä½ç½®è¿›è¡Œå¯»å€ï¼Œå› æ­¤å®é™…ä¸Šè¿™ä¸ª a ä¾èµ–åªç”¨å ç”¨ 1MB çš„ç©ºé—´ï¼Œè€Œä¸æ˜¯ 2MBã€‚

#### Store ç›®å½•

ä¸Šä¸€èŠ‚æåˆ° store ç›®å½•ç”¨äºå­˜å‚¨ä¾èµ–çš„ hard linksï¼Œè¿™ä¸€èŠ‚ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ª store ç›®å½•ã€‚

ä¸€èˆ¬ store ç›®å½•é»˜è®¤æ˜¯è®¾ç½®åœ¨ `${os.homedir}/.pnpm-store` è¿™ä¸ªç›®å½•ä¸‹ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ `@pnpm/store-path` è¿™ä¸ª pnpm å­åŒ…ä¸­çš„ä»£ç :

```js
const homedir = os.homedir()
if (await canLinkToSubdir(tempFile, homedir)) {
  await fs.unlink(tempFile)
  // If the project is on the drive on which the OS home directory
  // then the store is placed in the home directory
  return path.join(homedir, relStore, STORE_VERSION)
}

```

å½“ç„¶ç”¨æˆ·ä¹Ÿå¯ä»¥åœ¨ `.npmrc` è®¾ç½®è¿™ä¸ª store ç›®å½•ä½ç½®ï¼Œä¸è¿‡ä¸€èˆ¬è€Œè¨€ store ç›®å½•å¯¹äºç”¨æˆ·æ¥è¯´æ„ŸçŸ¥ç¨‹åº¦æ˜¯æ¯”è¾ƒå°çš„ã€‚

å› ä¸ºè¿™æ ·ä¸€ä¸ªæœºåˆ¶ï¼Œå¯¼è‡´æ¯æ¬¡å®‰è£…ä¾èµ–çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯ä¸ªç›¸åŒçš„ä¾èµ–ï¼Œæœ‰å¥½å¤šé¡¹ç›®éƒ½ç”¨åˆ°è¿™ä¸ªä¾èµ–ï¼Œé‚£ä¹ˆè¿™ä¸ªä¾èµ–å®é™…ä¸Šæœ€ä¼˜æƒ…å†µ(å³ç‰ˆæœ¬ç›¸åŒ)åªç”¨å®‰è£…ä¸€æ¬¡ã€‚

å¦‚æœæ˜¯ npm æˆ– yarnï¼Œé‚£ä¹ˆè¿™ä¸ªä¾èµ–åœ¨å¤šä¸ªé¡¹ç›®ä¸­ä½¿ç”¨ï¼Œåœ¨æ¯æ¬¡å®‰è£…çš„æ—¶å€™éƒ½ä¼šè¢«é‡æ–°ä¸‹è½½ä¸€æ¬¡ã€‚

![03](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ba60f4713bc46318ee139d3b8a9bc82~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å¦‚å›¾å¯ä»¥çœ‹åˆ°åœ¨ä½¿ç”¨ pnpm å¯¹é¡¹ç›®å®‰è£…ä¾èµ–çš„æ—¶å€™ï¼Œå¦‚æœæŸä¸ªä¾èµ–åœ¨ sotre ç›®å½•ä¸­å­˜åœ¨äº†è¯ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥ä» store ç›®å½•é‡Œé¢å» hard-linkï¼Œé¿å…äº†äºŒæ¬¡å®‰è£…å¸¦æ¥çš„æ—¶é—´æ¶ˆè€—ï¼Œå¦‚æœä¾èµ–åœ¨ store ç›®å½•é‡Œé¢ä¸å­˜åœ¨çš„è¯ï¼Œå°±ä¼šå»ä¸‹è½½ä¸€æ¬¡ã€‚

å½“ç„¶è¿™é‡Œä½ å¯èƒ½ä¹Ÿä¼šæœ‰é—®é¢˜ï¼šå¦‚æœå®‰è£…äº†å¾ˆå¤šå¾ˆå¤šä¸åŒçš„ä¾èµ–ï¼Œé‚£ä¹ˆ store ç›®å½•ä¼šä¸ä¼šè¶Šæ¥è¶Šå¤§ï¼Ÿ

ç­”æ¡ˆæ˜¯å½“ç„¶ä¼šå­˜åœ¨ï¼Œé’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œpnpm æä¾›äº†ä¸€ä¸ªå‘½ä»¤æ¥è§£å†³è¿™ä¸ªé—®é¢˜: [pnpm store | pnpm](https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2Fcli%2Fstore "https://pnpm.io/cli/store")ã€‚

åŒæ—¶è¯¥å‘½ä»¤æä¾›äº†ä¸€ä¸ªé€‰é¡¹ï¼Œä½¿ç”¨æ–¹æ³•ä¸º `pnpm store prune` ï¼Œå®ƒæä¾›äº†ä¸€ç§ç”¨äºåˆ é™¤ä¸€äº›ä¸è¢«å…¨å±€é¡¹ç›®æ‰€å¼•ç”¨åˆ°çš„ packages çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æœ‰ä¸ªåŒ… `axios@1.0.0` è¢«ä¸€ä¸ªé¡¹ç›®æ‰€å¼•ç”¨äº†ï¼Œä½†æ˜¯æŸæ¬¡ä¿®æ”¹ä½¿å¾—é¡¹ç›®é‡Œè¿™ä¸ªåŒ…è¢«æ›´æ–°åˆ°äº† `1.0.1` ï¼Œé‚£ä¹ˆ store é‡Œé¢çš„ 1.0.0 çš„ axios å°±å°±æˆäº†ä¸ªä¸è¢«å¼•ç”¨çš„åŒ…ï¼Œæ‰§è¡Œ `pnpm store prune` å°±å¯ä»¥åœ¨ store é‡Œé¢åˆ æ‰å®ƒäº†ã€‚

è¯¥å‘½ä»¤æ¨èå¶å°”è¿›è¡Œä½¿ç”¨ï¼Œä½†ä¸è¦é¢‘ç¹ä½¿ç”¨ï¼Œå› ä¸ºå¯èƒ½æŸå¤©è¿™ä¸ªä¸è¢«å¼•ç”¨çš„åŒ…åˆçªç„¶è¢«å“ªä¸ªé¡¹ç›®å¼•ç”¨äº†ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨å†å»é‡æ–°ä¸‹è½½è¿™ä¸ªåŒ…äº†ã€‚

#### node\_modules ç»“æ„

åœ¨ pnpm å®˜ç½‘æœ‰ä¸€ç¯‡å¾ˆç»å…¸çš„æ–‡ç« ï¼Œå…³äºä»‹ç» pnpm é¡¹ç›®çš„ node\_modules ç»“æ„: [Flat node\_modules is not the only way | pnpm](https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2Fblog%2F2020%2F05%2F27%2Fflat-node-modules-is-not-the-only-way "https://pnpm.io/blog/2020/05/27/flat-node-modules-is-not-the-only-way")ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»äº† pnpm ç›®å‰çš„ node\_modules çš„ä¸€äº›æ–‡ä»¶ç»“æ„ï¼Œä¾‹å¦‚åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ pnpm å®‰è£…äº†ä¸€ä¸ªå«åš `express` çš„ä¾èµ–ï¼Œé‚£ä¹ˆæœ€åä¼šåœ¨ node\_modules ä¸­å½¢æˆè¿™æ ·ä¸¤ä¸ªç›®å½•ç»“æ„:

```bash
node_modules/express/...
node_modules/.pnpm/express@4.17.1/node_modules/xxx

```

å…¶ä¸­ç¬¬ä¸€ä¸ªè·¯å¾„æ˜¯ nodejs æ­£å¸¸å¯»æ‰¾è·¯å¾„ä¼šå»æ‰¾çš„ä¸€ä¸ªç›®å½•ï¼Œå¦‚æœå»æŸ¥çœ‹è¿™ä¸ªç›®å½•ä¸‹çš„å†…å®¹ï¼Œä¼šå‘ç°é‡Œé¢è¿ä¸ª `node_modules` æ–‡ä»¶éƒ½æ²¡æœ‰ï¼š

```bash
â–¾ express
    â–¸ lib
      History.md
      index.js
      LICENSE
      package.json
      Readme.md

```

å®é™…ä¸Šè¿™ä¸ªæ–‡ä»¶åªæ˜¯ä¸ªè½¯è¿æ¥ï¼Œå®ƒä¼šå½¢æˆä¸€ä¸ªåˆ°ç¬¬äºŒä¸ªç›®å½•çš„ä¸€ä¸ªè½¯è¿æ¥(ç±»ä¼¼äºè½¯ä»¶çš„å¿«æ·æ–¹å¼)ï¼Œè¿™æ · node åœ¨æ‰¾è·¯å¾„çš„æ—¶å€™ï¼Œæœ€ç»ˆä¼šæ‰¾åˆ° .pnpm è¿™ä¸ªç›®å½•ä¸‹çš„å†…å®¹ã€‚

å…¶ä¸­è¿™ä¸ª `.pnpm` æ˜¯ä¸ªè™šæ‹Ÿç£ç›˜ç›®å½•ï¼Œç„¶å express è¿™ä¸ªä¾èµ–çš„ä¸€äº›ä¾èµ–ä¼šè¢«å¹³é“ºåˆ° `.pnpm/express@4.17.1/node_modules/` è¿™ä¸ªç›®å½•ä¸‹é¢ï¼Œè¿™æ ·ä¿è¯äº†ä¾èµ–èƒ½å¤Ÿ require åˆ°ï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šå½¢æˆå¾ˆæ·±çš„ä¾èµ–å±‚çº§ã€‚

åœ¨ä¿è¯äº† nodejs èƒ½æ‰¾åˆ°ä¾èµ–è·¯å¾„çš„åŸºç¡€ä¸Šï¼ŒåŒæ—¶ä¹Ÿå¾ˆå¤§ç¨‹åº¦ä¸Šä¿è¯äº†ä¾èµ–èƒ½å¾ˆå¥½çš„è¢«æ”¾åœ¨ä¸€èµ·ã€‚

`pnpm` å¯¹äºä¸åŒç‰ˆæœ¬çš„ä¾èµ–æœ‰ç€æå…¶ä¸¥æ ¼çš„åŒºåˆ†è¦æ±‚ï¼Œå¦‚æœé¡¹ç›®ä¸­æŸä¸ªä¾èµ–å®é™…ä¸Šä¾èµ–çš„ `peerDeps` å‡ºç°äº†å…·ä½“ç‰ˆæœ¬ä¸Šçš„ä¸åŒï¼Œå¯¹äºè¿™æ ·çš„ä¾èµ–ä¼šåœ¨è™šæ‹Ÿç£ç›˜ç›®å½• `.pnpm` æœ‰ä¸€ä¸ªæ¯”è¾ƒä¸¥æ ¼çš„åŒºåˆ†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ: [pnpm.io/how-peers-aâ€¦](https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2Fhow-peers-are-resolved "https://pnpm.io/how-peers-are-resolved") è¿™ç¯‡æ–‡ç« ã€‚

ç»¼åˆè€Œè¨€ï¼Œæœ¬è´¨ä¸Š pnpm çš„ `node_modules` ç»“æ„æ˜¯ä¸ªç½‘çŠ¶ + å¹³é“ºçš„ç›®å½•ç»“æ„ã€‚è¿™ç§ä¾èµ–ç»“æ„ä¸»è¦åŸºäºè½¯è¿æ¥(å³ symlink)çš„æ–¹å¼æ¥å®Œæˆã€‚

#### symlink å’Œ hard link æœºåˆ¶

åœ¨å‰é¢çŸ¥é“äº† pnpm æ˜¯é€šè¿‡ hardlink åœ¨å…¨å±€é‡Œé¢æä¸ª store ç›®å½•æ¥å­˜å‚¨ node\_modules ä¾èµ–é‡Œé¢çš„ hard link åœ°å€ï¼Œç„¶ååœ¨å¼•ç”¨ä¾èµ–çš„æ—¶å€™åˆ™æ˜¯é€šè¿‡ symlink å»æ‰¾åˆ°å¯¹åº”è™šæ‹Ÿç£ç›˜ç›®å½•ä¸‹(.pnpm ç›®å½•)çš„ä¾èµ–åœ°å€ã€‚

è¿™ä¸¤è€…ç»“åˆåœ¨ä¸€èµ·å·¥ä½œä¹‹åï¼Œå‡å¦‚æœ‰ä¸€ä¸ªé¡¹ç›®ä¾èµ–äº† `bar@1.0.0` å’Œ `foo@1.0.0` ï¼Œé‚£ä¹ˆæœ€åçš„ node\_modules ç»“æ„å‘ˆç°å‡ºæ¥çš„ä¾èµ–ç»“æ„å¯èƒ½ä¼šæ˜¯è¿™æ ·çš„:

```bash
node_modules
â””â”€â”€ bar // symlink to .pnpm/bar@1.0.0/node_modules/bar
â””â”€â”€ foo // symlink to .pnpm/foo@1.0.0/node_modules/foo
â””â”€â”€ .pnpm
    â”œâ”€â”€ bar@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ bar -> <store>/bar
    â”‚           â”œâ”€â”€ index.js
    â”‚           â””â”€â”€ package.json
    â””â”€â”€ foo@1.0.0
        â””â”€â”€ node_modules
            â””â”€â”€ foo -> <store>/foo
                â”œâ”€â”€ index.js
                â””â”€â”€ package.json

```

`node_modules` ä¸­çš„ bar å’Œ foo ä¸¤ä¸ªç›®å½•ä¼šè½¯è¿æ¥åˆ° .pnpm è¿™ä¸ªç›®å½•ä¸‹çš„çœŸå®ä¾èµ–ä¸­ï¼Œè€Œè¿™äº›çœŸå®ä¾èµ–åˆ™æ˜¯é€šè¿‡ hard link å­˜å‚¨åˆ°å…¨å±€çš„ store ç›®å½•ä¸­ã€‚

#### å…¼å®¹é—®é¢˜

è¯»åˆ°è¿™é‡Œï¼Œå¯èƒ½æœ‰ç”¨æˆ·ä¼šå¥½å¥‡: åƒ hard link å’Œ symlink è¿™ç§æ–¹å¼åœ¨æ‰€æœ‰çš„ç³»ç»Ÿä¸Šéƒ½æ˜¯å…¼å®¹çš„å—ï¼Ÿ

å®é™…ä¸Š hard link åœ¨ä¸»æµç³»ç»Ÿä¸Š(`Unix/Win`)ä½¿ç”¨éƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ symlink å³è½¯è¿æ¥çš„æ–¹å¼å¯èƒ½ä¼šåœ¨ windows å­˜åœ¨ä¸€äº›å…¼å®¹çš„é—®é¢˜ï¼Œä½†æ˜¯é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œpnpm ä¹Ÿæä¾›äº†å¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼š

åœ¨ win ç³»ç»Ÿä¸Šä½¿ç”¨ä¸€ä¸ªå«åš [junctions](https://link.juejin.cn?target=https%3A%2F%2Fdocs.microsoft.com%2Fen-us%2Fwindows%2Fwin32%2Ffileio%2Fhard-links-and-junctions "https://docs.microsoft.com/en-us/windows/win32/fileio/hard-links-and-junctions") çš„ç‰¹æ€§æ¥æ›¿ä»£è½¯è¿æ¥ï¼Œè¿™ä¸ªæ–¹æ¡ˆåœ¨ win ä¸Šçš„å…¼å®¹æ€§è¦å¥½äº symlinkã€‚

æˆ–è®¸ä½ ä¹Ÿä¼šå¥½å¥‡ä¸ºå•¥ pnpm è¦ä½¿ç”¨ hard links è€Œä¸æ˜¯å…¨éƒ½ç”¨ symlink æ¥å»å®ç°ã€‚

å®é™…ä¸Šå­˜åœ¨ store ç›®å½•é‡Œé¢çš„ä¾èµ–ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡è½¯è¿æ¥å»æ‰¾åˆ°çš„ï¼Œnodejs æœ¬èº«æœ‰æä¾›ä¸€ä¸ªå«åš `--preserve-symlinks` çš„å‚æ•°æ¥æ”¯æŒ symlinkï¼Œä½†å®é™…ä¸Šè¿™ä¸ªå‚æ•°å®é™…ä¸Šå¯¹äº symlink çš„æ”¯æŒå¹¶ä¸å¥½å¯¼è‡´ä½œè€…æ”¾å¼ƒäº†è¯¥æ–¹æ¡ˆä»è€Œé‡‡ç”¨ hard links çš„æ–¹å¼:

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90ad9850716547d08bfbfea212d6d653~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

å…·ä½“å¯ä»¥å‚è€ƒ [github.com/nodejs/nodeâ€¦](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnodejs%2Fnode-eps%2Fissues%2F46 "https://github.com/nodejs/node-eps/issues/46") è¯¥issue è®¨è®ºã€‚

### Monorepo æ”¯æŒ

`pnpm` åœ¨ monorepo åœºæ™¯å¯ä»¥è¯´ç®—å¾—ä¸Šæ˜¯ä¸ªå®Œç¾çš„è§£å†³æ–¹æ¡ˆäº†ï¼Œå› ä¸ºå…¶æœ¬èº«çš„è®¾è®¡æœºåˆ¶ï¼Œå¯¼è‡´å¾ˆå¤šå…³é”®æˆ–è€…è¯´è‡´å‘½çš„é—®é¢˜éƒ½å¾—åˆ°äº†ç›¸å½“æœ‰æ•ˆçš„è§£å†³ã€‚

#### workspace æ”¯æŒ

å¯¹äº monorepo ç±»å‹çš„é¡¹ç›®ï¼Œpnpm æä¾›äº† workspace æ¥æ”¯æŒï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜ç½‘æ–‡æ¡£: [pnpm.io/workspaces/â€¦](https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2Fworkspaces%2F%25E3%2580%2582 "https://pnpm.io/workspaces/%E3%80%82")

### ç—›ç‚¹è§£å†³

Monorepo ä¸‹è¢«äººè¯Ÿç—…è¾ƒå¤šçš„é—®é¢˜ï¼Œä¸€èˆ¬æ˜¯ä¾èµ–ç»“æ„é—®é¢˜ã€‚å¸¸è§çš„ä¸¤ä¸ªé—®é¢˜å°±æ˜¯ `Phantom dependencies` å’Œ `NPM doppelgangers`ï¼Œç”¨ [rush å®˜ç½‘](https://link.juejin.cn?target=https%3A%2F%2Frushjs.io%2F "https://rushjs.io/") çš„å›¾ç‰‡å¯ä»¥å¾ˆè´´åˆ‡çš„å±•ç¤ºç€ä¸¤ä¸ªé—®é¢˜:

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/977bd60346d04cc8a4565e3e398bd962~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ä¸‹é¢ä¼šé’ˆå¯¹ä¸¤ä¸ªé—®é¢˜ä¸€ä¸€ä»‹ç»ã€‚

#### Phantom dependencies

Phantom dependencies è¢«ç§°ä¹‹ä¸ºå¹½çµä¾èµ–ï¼Œè§£é‡Šèµ·æ¥å¾ˆç®€å•ï¼Œå³æŸä¸ªåŒ…æ²¡æœ‰è¢«å®‰è£…(`package.json` ä¸­å¹¶æ²¡æœ‰ï¼Œä½†æ˜¯ç”¨æˆ·å´èƒ½å¤Ÿå¼•ç”¨åˆ°è¿™ä¸ªåŒ…)ã€‚

å¼•å‘è¿™ä¸ªç°è±¡çš„åŸå› ä¸€èˆ¬æ˜¯å› ä¸º node\_modules ç»“æ„æ‰€å¯¼è‡´çš„ï¼Œä¾‹å¦‚ä½¿ç”¨ yarn å¯¹é¡¹ç›®å®‰è£…ä¾èµ–ï¼Œä¾èµ–é‡Œé¢æœ‰ä¸ªä¾èµ–å«åš fooï¼Œfoo è¿™ä¸ªä¾èµ–åŒæ—¶ä¾èµ–äº† barï¼Œyarn ä¼šå¯¹å®‰è£…çš„ node\_modules åšä¸€ä¸ªæ‰å¹³åŒ–ç»“æ„çš„å¤„ç†(npm v3 ä¹‹åä¹Ÿæ˜¯è¿™ä¹ˆåšçš„)ï¼Œä¼šæŠŠä¾èµ–åœ¨ node\_modules ä¸‹æ‰“å¹³ï¼Œè¿™æ ·ç›¸å½“äº foo å’Œ bar å‡ºç°åœ¨åŒä¸€å±‚çº§ä¸‹é¢ã€‚é‚£ä¹ˆæ ¹æ® nodejs çš„å¯»å¾„åŸç†ï¼Œç”¨æˆ·èƒ½ require åˆ° fooï¼ŒåŒæ ·ä¹Ÿèƒ½ require åˆ° barã€‚

```bash
package.json -> foo(bar ä¸º foo ä¾èµ–)

node_modules

  /foo

  /bar -> ğŸ‘»ä¾èµ–

```

é‚£ä¹ˆè¿™é‡Œè¿™ä¸ª bar å°±æˆäº†ä¸€ä¸ªå¹½çµä¾èµ–ï¼Œå¦‚æœæŸå¤©æŸä¸ªç‰ˆæœ¬çš„ foo ä¾èµ–ä¸å†ä¾èµ– bar æˆ–è€… foo çš„ç‰ˆæœ¬å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆ require bar çš„æ¨¡å—éƒ¨åˆ†å°±ä¼šæŠ›é”™ã€‚

ä»¥ä¸Šå…¶å®åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½†æ˜¯æ ¹æ®ç¬”è€…åœ¨å­—èŠ‚å†…éƒ¨è§åˆ°çš„ä¸€äº› monorepo(ä¸»è¦ä¸º `lerna + yarn` )é¡¹ç›®ä¸­ï¼Œè¿™å…¶å®æ˜¯ä¸ªæ¯”è¾ƒå¸¸è§çš„ç°è±¡ï¼Œç”šè‡³æœ‰äº›åŒ…ä¼šç›´æ¥å»åˆ©ç”¨è¿™ç§æ®‹ç¼ºçš„å¼•å…¥æ–¹å¼å»å‡è½»åŒ…ä½“ç§¯ã€‚

è¿˜æœ‰ä¸€ç§åœºæ™¯å°±æ˜¯åœ¨ lerna + yarn workspace çš„é¡¹ç›®é‡Œé¢ï¼Œå› ä¸º yarn ä¸­æä¾›äº† hoist æœºåˆ¶(å³ä¸€äº›åº•å±‚å­é¡¹ç›®çš„ä¾èµ–ä¼šè¢«æå‡åˆ°é¡¶å±‚çš„ `node_modules` ä¸­)ï¼Œè¿™ç§ phantom dependencies ä¼šæ›´å¤šï¼Œä¸€äº›åº•å±‚çš„å­é¡¹ç›®ç»å¸¸ä¼šå» require ä¸€äº›åœ¨è‡ªå·±é‡Œé¢æ²¡æœ‰å¼•å…¥çš„ä¾èµ–ï¼Œè€Œç›´æ¥å»æ‰¾é¡¶å±‚ node\_modules çš„ä¾èµ–(nodejs è¿™é‡Œçš„å¯»å¾„æ˜¯ä¸ªé€’å½’ä¸Šä¸‹çš„è¿‡ç¨‹)å¹¶ä½¿ç”¨ã€‚

è€Œæ ¹æ®å‰é¢æåˆ°çš„ pnpm çš„ `node_modules` ä¾èµ–ç»“æ„ï¼Œè¿™ç§ç°è±¡æ˜¯æ˜¾ç„¶ä¸ä¼šå‘ç”Ÿçš„ï¼Œå› ä¸ºè¢«æ‰“å¹³çš„ä¾èµ–ä¼šè¢«æ”¾åˆ° `.pnpm` è¿™ä¸ªè™šæ‹Ÿç£ç›˜ç›®å½•ä¸‹é¢å»ï¼Œç”¨æˆ·é€šè¿‡ require æ˜¯æ ¹æœ¬æ‰¾ä¸åˆ°çš„ã€‚

> å€¼å¾—ä¸€æçš„æ˜¯ï¼Œpnpm æœ¬èº«å…¶å®ä¹Ÿæä¾›äº†å°†ä¾èµ–æå‡å¹¶ä¸”æŒ‰ç…§ yarn é‚£ç§å½¢å¼ç»„ç»‡çš„ node\_modules ç»“æ„çš„ Optionï¼Œä½œè€…å°†å…¶å‘½åä¸º `--shamefully-hoist` ï¼Œå³ "ç¾è€»çš„ hoist".....

#### NPM doppelgangers

è¿™ä¸ªé—®é¢˜å…¶å®ä¹Ÿå¯ä»¥è¯´æ˜¯ hoist å¯¼è‡´çš„ï¼Œè¿™ä¸ªé—®é¢˜å¯èƒ½ä¼šå¯¼è‡´æœ‰å¤§é‡çš„ä¾èµ–çš„è¢«é‡å¤å®‰è£…ï¼Œä¸¾ä¸ªä¾‹å­:

ä¾‹å¦‚æœ‰ä¸ª packageï¼Œä¸‹é¢ä¾èµ–æœ‰ lib\_aã€lib\_bã€lib\_cã€lib\_dï¼Œå…¶ä¸­ a å’Œ b ä¾èµ– [util\_e@1.0.0](https://link.juejin.cn?target=mailto%3Autil_e%401.0.0 "mailto:util_e@1.0.0")ï¼Œè€Œ c å’Œ d ä¾èµ– [util\_e@2.0.0](https://link.juejin.cn?target=mailto%3Autil_e%402.0.0 "mailto:util_e@2.0.0")ã€‚

é‚£ä¹ˆæ—©æœŸ npm çš„ä¾èµ–ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„:

```bash
- package
- package.json
- node_modules
- lib_a
  - node_modules <- util_e@1.0.0
- lib_b
  - node_modules <- util_e@1.0.0
_ lib_c
  - node_modules <- util_e@2.0.0
- lib_d
  - node_modules <- util_e@2.0.0

```

è¿™æ ·å¿…ç„¶ä¼šå¯¼è‡´å¾ˆå¤šä¾èµ–è¢«é‡å¤å®‰è£…ï¼Œäºæ˜¯å°±æœ‰äº† hoist å’Œæ‰“å¹³ä¾èµ–çš„æ“ä½œ:

```bash
- package
- package.json
- node_modules
- util_e@1.0.0
- lib_a
- lib_b
_ lib_c
  - node_modules <- util_e@2.0.0
- lib_d
  - node_modules <- util_e@2.0.0

```

ä½†æ˜¯è¿™æ ·ä¹Ÿåªèƒ½æå‡ä¸€ä¸ªä¾èµ–ï¼Œå¦‚æœä¸¤ä¸ªä¾èµ–éƒ½æå‡äº†ä¼šå¯¼è‡´å†²çªï¼Œè¿™æ ·åŒæ ·ä¼šå¯¼è‡´ä¸€äº›ä¸åŒç‰ˆæœ¬çš„ä¾èµ–è¢«é‡å¤å®‰è£…å¤šæ¬¡ï¼Œè¿™é‡Œå°±ä¼šå¯¼è‡´ä½¿ç”¨ npm å’Œ yarn çš„æ€§èƒ½æŸå¤±ã€‚

å¦‚æœæ˜¯ pnpm çš„è¯ï¼Œè¿™é‡Œå› ä¸ºä¾èµ–å§‹ç»ˆéƒ½æ˜¯å­˜åœ¨ store ç›®å½•ä¸‹çš„ hard links ï¼Œä¸€ä»½ä¸åŒçš„ä¾èµ–å§‹ç»ˆéƒ½åªä¼šè¢«å®‰è£…ä¸€æ¬¡ï¼Œå› æ­¤è¿™ä¸ªæ˜¯èƒ½å¤Ÿè¢«å½»å½»åº•åº•çš„æ¶ˆé™¤çš„ã€‚

### ç›®å‰ä¸é€‚ç”¨çš„åœºæ™¯

å‰é¢æœ‰æåˆ°å…³äº pnpm çš„ä¸»è¦é—®é¢˜åœ¨äº symlink(è½¯é“¾æ¥)åœ¨ä¸€äº›åœºæ™¯ä¸‹ä¼šå­˜åœ¨å…¼å®¹çš„é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒä½œè€…åœ¨ nodejs é‚£è¾¹å¼€çš„ä¸€ä¸ª discussionï¼š[github.com/nodejs/nodeâ€¦](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnodejs%2Fnode%2Fdiscussions%2F37509 "https://github.com/nodejs/node/discussions/37509")

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2fb3e4b6b5ef43dc9e8437389d2cb46e~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

åœ¨é‡Œé¢ä½œè€…æåˆ°äº†ç›®å‰ nodejs è½¯è¿æ¥ä¸èƒ½é€‚ç”¨çš„ä¸€äº›åœºæ™¯ï¼Œå¸Œæœ› nodejs èƒ½æä¾›ä¸€ç§ link æ–¹å¼è€Œä¸æ˜¯ä½¿ç”¨è½¯è¿æ¥ï¼ŒåŒæ—¶ä¹Ÿæåˆ°äº† pnpm ç›®å‰å› ä¸ºè½¯è¿æ¥è€Œä¸èƒ½ä½¿ç”¨çš„åœºæ™¯:

* Electron åº”ç”¨æ— æ³•ä½¿ç”¨ pnpm
* éƒ¨ç½²åœ¨ [lambda](https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Flambda%2Flatest%2Fdg%2Fgettingstarted-package.html "https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-package.html") ä¸Šçš„åº”ç”¨æ— æ³•ä½¿ç”¨ pnpm

ç¬”è€…åœ¨å­—èŠ‚å†…éƒ¨ä½¿ç”¨ pnpm æ—¶ä¹Ÿé‡åˆ°è¿‡ä¸€äº› nodejs åŸºç¡€åº“ä¸æ”¯æŒ symlink çš„æƒ…å†µå¯¼è‡´ä½¿ç”¨ pnpm æ— æ³•æ­£å¸¸å·¥ä½œï¼Œä¸è¿‡è¿™äº›åº“åœ¨è¿­ä»£æ›´æ–°ä¹‹åä¹Ÿä¼šæ”¯æŒè¿™ä¸€ç‰¹æ€§ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b702b38ff6704651976c4c3eab540566~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)


## Comments / Answers

---

**yanlele** at 2023-03-21T16:04:48Z

å‚è€ƒæ–‡æ¡£: https://juejin.cn/post/7001794162970361892
