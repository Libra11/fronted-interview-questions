# WebSocket 协议的底层原理是什么【热度: 1,805】

- Issue: #360
- State: open
- Labels: 网络, 百度
- Author: yanlele
- URL: https://github.com/pro-collection/interview-question/issues/360
- Created: 2023-05-22T12:49:38Z
- Updated: 2023-05-22T12:49:39Z

## Body

**关键词**：WebSocket 协议、WebSocket 与 http 区别、全双工通信的协议

### WebSocket 通信原理 

WebSocket 是一种在Web浏览器和服务器之间进行全双工通信的协议，它通过一个长久的、双向的通信通道来实现实时数据传输。

下面是WebSocket协议的底层原理：

1. 握手（Handshake）：WebSocket连接的建立需要通过HTTP握手来升级到WebSocket协议。客户端首先发送一个HTTP请求，其中包含一些特定的头部信息，表明客户端希望升级到WebSocket协议。服务器收到请求后，如果支持WebSocket协议，就会返回一个带有特定头部的HTTP响应，表示握手成功。握手完成后，连接从HTTP协议切换到了WebSocket协议。

2. 数据帧（Data Frames）：一旦握手成功，WebSocket连接就处于打开状态，可以进行数据传输。数据以数据帧的形式在客户端和服务器之间进行传输。数据帧是WebSocket协议中的基本单位，它包含了有效负载（payload）和一些控制信息。有效负载可以是文本数据或二进制数据。

3. 帧格式（Frame Format）：WebSocket数据帧的格式相对简单。它以字节流的形式进行传输，通常由以下几个部分组成：

   * FIN（1 bit）：表示消息是否已完成，如果消息只占用一个帧，该位为1，否则为0。
   * RSV1、RSV2、RSV3（各占1 bit）：用于扩展使用，目前很少使用。
   * Opcode（4 bits）：表示消息类型，例如文本数据、二进制数据、连接关闭等。
   * Mask（1 bit）：指示是否对有效负载进行掩码处理。
   * Payload Length（7 bits或16 bits或64 bits）：表示有效负载的长度。
   * Masking Key（0或32 bits）：如果Mask位为1，表示用于对有效负载进行掩码处理的密钥。
   * Payload Data：实际的有效负载数据。

4. 数据传输：数据通过TCP连接进行传输。WebSocket建立在TCP协议之上，利用TCP的可靠性和双向通信能力来传输数据。客户端和服务器可以随时发送数据帧，数据帧可以被分割成多个TCP包进行传输，接收方会将这些包重新组装成完整的数据帧。

5. 心跳机制：为了保持连接的活跃状态，WebSocket使用心跳机制来定期发送心跳消息。这些心跳消息可以是空的数据帧或特定的控制帧，服务器可以通过检测心跳消息来确定连接是否仍然有效。

通过以上步骤，WebSocket协议能够在浏览器和服务器之间建立一个持久的、全双工的通信通道，实现实时的双向数据传输。相比传统的HTTP请求，WebSocket减少了通信的延迟，并且能够更高效地进行实时数据交换。


### WebSocket 协议 和 http 协议有什么区别

WebSocket协议和HTTP协议有以下几个主要区别：

1. 连接方式：HTTP协议是基于请求-响应模式的，每次请求都需要建立一个新的连接，并在响应完成后立即关闭连接。而WebSocket协议通过一次握手连接后，保持长久的双向连接，允许服务器主动向客户端推送数据，实现实时的双向通信。

2. 数据格式：HTTP协议传输的数据一般采用文本或二进制的形式，但每次请求和响应都需要包含HTTP头部信息，使得数据传输的开销较大。WebSocket协议支持以原始的二进制格式进行数据传输，减少了数据传输的开销，并且提供了更低的延迟。

3. 通信效率：由于HTTP协议每次请求都需要建立和关闭连接，对于频繁的数据交换场景效率较低。而WebSocket协议通过保持长连接，避免了多次建立连接的开销，从而提高了通信的效率。

4. 服务器推送：HTTP协议是一种单向的协议，客户端需要不断地向服务器发送请求以获取数据。而WebSocket协议支持服务器主动向客户端推送数据，服务器可以随时向客户端发送消息，实现实时的双向通信。

综上所述，WebSocket协议相比HTTP协议在实时通信和双向通信方面更加高效和灵活，适用于需要实时数据传输和双向交互的应用场景，如在线聊天、实时游戏、股票行情等。而HTTP协议则适用于传统的请求-响应模式的数据交换，如网页浏览、文件下载等。



