<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>[Webpack] webpackçƒ­æ›´æ–°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ - é¢è¯•é¢˜åˆ·é¢˜</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <meta name="description" content="&lt;blockquote&gt; &lt;code&gt;Hot Module Replacement&lt;/code&gt;ï¼Œç®€ç§°&lt;code&gt;HMR&lt;/code&gt;ï¼Œæ— éœ€å®Œå…¨åˆ·æ–°æ•´ä¸ªé¡µé¢çš„åŒæ—¶ï¼Œæ›´æ–°æ¨¡å—ã€‚&lt;code&gt;HMR&lt;/code&gt;çš„å¥½å¤„ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­ä½“ä¼šé¢‡æ·±ï¼š&lt;strong&gt;èŠ‚çœå®è´µçš„å¼€å‘æ—¶é—´ã€æå‡" />
  <link rel="icon" href="../assets/favicon.svg" />
  <style>.content a{color:var(--brand);} .content img{max-width:100%;}</style>
  
  <!-- Open Graph -->
  <meta property="og:title" content="[Webpack] webpackçƒ­æ›´æ–°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="&lt;blockquote&gt; &lt;code&gt;Hot Module Replacement&lt;/code&gt;ï¼Œç®€ç§°&lt;code&gt;HMR&lt;/code&gt;ï¼Œæ— éœ€å®Œå…¨åˆ·æ–°æ•´ä¸ªé¡µé¢çš„åŒæ—¶ï¼Œæ›´æ–°æ¨¡å—ã€‚&lt;code&gt;HMR&lt;/code&gt;çš„å¥½å¤„ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­ä½“ä¼šé¢‡æ·±ï¼š&lt;strong&gt;èŠ‚çœå®è´µçš„å¼€å‘æ—¶é—´ã€æå‡å¼€å‘ä½“éªŒ&lt;/strong&gt;ã€‚&lt;/blockquote&gt;&lt;p&gt;åˆ·æ–°æˆ‘ä»¬ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;ä¸€ç§æ˜¯é¡µé¢åˆ·æ–°" />
  <meta property="og:locale" content="zh_CN" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="../index.html">é¢è¯•é¢˜åˆ·é¢˜</a>
      <nav class="nav">
        <a href="../index.html">é¦–é¡µ</a>
        <a href="../index.html#categories">åˆ†ç±»</a>
        <a href="https://github.com/pro-collection/interview-question/issues/267" target="_blank" rel="noopener">åŸå§‹é“¾æ¥</a>
      </nav>
    </div>
  </header>
  <main class="container article">
    <div class="article-head">
      <a class="back" href="../index.html">â† è¿”å›åˆ—è¡¨</a>
      <h1>[Webpack] webpackçƒ­æ›´æ–°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</h1>
      <div class="subtitle">å·¥ç¨‹åŒ– Â· å·¥ç¨‹åŒ–</div>
      <div class="meta">åˆ›å»ºï¼š2023-04-09T04:38:38Z Â· æ›´æ–°ï¼š2024-05-26T06:11:01Z</div>
    </div>
    <article class="content markdown-body"><blockquote> <code>Hot Module Replacement</code>ï¼Œç®€ç§°<code>HMR</code>ï¼Œæ— éœ€å®Œå…¨åˆ·æ–°æ•´ä¸ªé¡µé¢çš„åŒæ—¶ï¼Œæ›´æ–°æ¨¡å—ã€‚<code>HMR</code>çš„å¥½å¤„ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­ä½“ä¼šé¢‡æ·±ï¼š<strong>èŠ‚çœå®è´µçš„å¼€å‘æ—¶é—´ã€æå‡å¼€å‘ä½“éªŒ</strong>ã€‚</blockquote><p>åˆ·æ–°æˆ‘ä»¬ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>ä¸€ç§æ˜¯é¡µé¢åˆ·æ–°ï¼Œä¸ä¿ç•™é¡µé¢çŠ¶æ€ï¼Œå°±æ˜¯ç®€å•ç²—æš´ï¼Œç›´æ¥<code>window.location.reload()</code>ã€‚</li><li>å¦ä¸€ç§æ˜¯åŸºäº<code>WDS (Webpack-dev-server)</code>çš„æ¨¡å—çƒ­æ›¿æ¢ï¼Œåªéœ€è¦å±€éƒ¨åˆ·æ–°é¡µé¢ä¸Šå‘ç”Ÿå˜åŒ–çš„æ¨¡å—ï¼ŒåŒæ—¶å¯ä»¥ä¿ç•™å½“å‰çš„é¡µé¢çŠ¶æ€ï¼Œæ¯”å¦‚å¤é€‰æ¡†çš„é€‰ä¸­çŠ¶æ€ã€è¾“å…¥æ¡†çš„è¾“å…¥ç­‰ã€‚</li></ul><p><code>HMR</code>ä½œä¸ºä¸€ä¸ª<code>Webpack</code>å†…ç½®çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡<code>HotModuleReplacementPlugin</code>æˆ–<code>--hot</code>å¼€å¯ã€‚é‚£ä¹ˆï¼Œ<code>HMR</code>åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çƒ­æ›´æ–°çš„å‘¢ï¼Ÿä¸‹é¢è®©æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å§ï¼</p><h3>1. webpack-dev-serverå¯åŠ¨æœ¬åœ°æœåŠ¡</h3><p>æˆ‘ä»¬æ ¹æ®<code>webpack-dev-server</code>çš„<code>package.json</code>ä¸­çš„<code>bin</code>å‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°å‘½ä»¤çš„å…¥å£æ–‡ä»¶<code>bin/webpack-dev-server.js</code>ã€‚</p><pre class="code-block"><code class="language-pgsql">// node_modules/webpack-dev-server/bin/webpack-dev-server.js

// ç”Ÿæˆwebpackç¼–è¯‘ä¸»å¼•æ“ compiler
let compiler = webpack(config);

// å¯åŠ¨æœ¬åœ°æœåŠ¡
let server = new Server(compiler, options, log);
server.listen(options.port, options.host, (err) =&gt; {
    if (err) {throw err};
});
</code></pre><p>æœ¬åœ°æœåŠ¡ä»£ç ï¼š</p><pre class="code-block"><code class="language-javascript">// node_modules/webpack-dev-server/lib/Server.js
class Server {
    constructor() {
        this.setupApp();
        this.createServer();
    }

    setupApp() {
        // ä¾èµ–äº†express
    	this.app = new express();
    }

    createServer() {
        this.listeningApp = http.createServer(this.app);
    }
    listen(port, hostname, fn) {
        return this.listeningApp.listen(port, hostname, (err) =&gt; {
            // å¯åŠ¨expressæœåŠ¡åï¼Œå¯åŠ¨websocketæœåŠ¡
            this.createSocketServer();
        }
    }
}
</code></pre><p>è¿™ä¸€å°èŠ‚ä»£ç ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š</p><ul><li>å¯åŠ¨<code>webpack</code>ï¼Œç”Ÿæˆ<code>compiler</code>å®ä¾‹ã€‚<code>compiler</code>ä¸Šæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œæ¯”å¦‚å¯ä»¥å¯åŠ¨ <code>webpack</code> æ‰€æœ‰<strong>ç¼–è¯‘</strong>å·¥ä½œï¼Œä»¥åŠ<strong>ç›‘å¬</strong>æœ¬åœ°æ–‡ä»¶çš„å˜åŒ–ã€‚</li><li>ä½¿ç”¨<code>express</code>æ¡†æ¶å¯åŠ¨æœ¬åœ°<code>server</code>ï¼Œè®©æµè§ˆå™¨å¯ä»¥è¯·æ±‚æœ¬åœ°çš„<strong>é™æ€èµ„æº</strong>ã€‚</li><li>æœ¬åœ°<code>server</code>å¯åŠ¨ä¹‹åï¼Œå†å»å¯åŠ¨<code>websocket</code>æœåŠ¡ï¼Œå¦‚æœä¸äº†è§£<code>websocket</code>ï¼Œå»ºè®®ç®€å•äº†è§£ä¸€ä¸‹<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2017%2F05%2Fwebsocket.html %22https://www.ruanyifeng.com/blog/2017/05/websocket.html%22" target="_blank" rel="noopener">websocketé€Ÿæˆ</a>ã€‚é€šè¿‡<code>websocket</code>ï¼Œå¯ä»¥å»ºç«‹æœ¬åœ°æœåŠ¡å’Œæµè§ˆå™¨çš„åŒå‘é€šä¿¡ã€‚è¿™æ ·å°±å¯ä»¥å®ç°å½“æœ¬åœ°æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œç«‹é©¬å‘ŠçŸ¥æµè§ˆå™¨å¯ä»¥çƒ­æ›´æ–°ä»£ç å•¦ï¼</li></ul><p>ä¸Šè¿°ä»£ç ä¸»è¦å¹²äº†ä¸‰ä»¶äº‹ï¼Œä½†æ˜¯æºç åœ¨å¯åŠ¨æœåŠ¡å‰åˆåšäº†å¾ˆå¤šäº‹ï¼Œæ¥ä¸‹æ¥ä¾¿çœ‹çœ‹<code>webpack-dev-server/lib/Server.js</code>è¿˜åšäº†å“ªäº›äº‹ï¼Ÿ</p><h3>2. ä¿®æ”¹webpack.config.jsçš„entryé…ç½®</h3><p>å¯åŠ¨æœ¬åœ°æœåŠ¡å‰ï¼Œè°ƒç”¨äº†<code>updateCompiler(this.compiler)</code>æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¸­æœ‰ 2 æ®µå…³é”®æ€§ä»£ç ã€‚ä¸€ä¸ªæ˜¯è·å–<code>websocket</code>å®¢æˆ·ç«¯ä»£ç è·¯å¾„ï¼Œå¦ä¸€ä¸ªæ˜¯æ ¹æ®é…ç½®è·å–<code>webpack</code>çƒ­æ›´æ–°ä»£ç è·¯å¾„ã€‚</p><pre class="code-block"><code class="language-javascript">// è·å–websocketå®¢æˆ·ç«¯ä»£ç 
const clientEntry = `${require.resolve(
    &#39;../../client/&#39;
)}?${domain}${sockHost}${sockPath}${sockPort}`;

// æ ¹æ®é…ç½®è·å–çƒ­æ›´æ–°ä»£ç 
let hotEntry;
if (options.hotOnly) {
    hotEntry = require.resolve(&#39;webpack/hot/only-dev-server&#39;);
} else if (options.hot) {
    hotEntry = require.resolve(&#39;webpack/hot/dev-server&#39;);
}
</code></pre><p>ä¿®æ”¹åçš„<code>webpack</code>å…¥å£é…ç½®å¦‚ä¸‹ï¼š</p><pre class="code-block"><code class="language-awk">// ä¿®æ”¹åçš„entryå…¥å£
{ entry:
    { index:
        [
            // ä¸Šé¢è·å–çš„clientEntry
            &#39;xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080&#39;,
            // ä¸Šé¢è·å–çš„hotEntry
            &#39;xxx/node_modules/webpack/hot/dev-server.js&#39;,
            // å¼€å‘é…ç½®çš„å…¥å£
            &#39;./src/index.js&#39;
    	],
    },
}      
</code></pre><p>ä¸ºä»€ä¹ˆè¦æ–°å¢äº† 2 ä¸ªæ–‡ä»¶ï¼Ÿåœ¨å…¥å£é»˜é»˜å¢åŠ äº† 2 ä¸ªæ–‡ä»¶ï¼Œé‚£å°±æ„å‘³ä¼šä¸€åŒæ‰“åŒ…åˆ°<code>bundle</code>æ–‡ä»¶ä¸­å»ï¼Œä¹Ÿå°±æ˜¯çº¿ä¸Šè¿è¡Œæ—¶ã€‚</p><p><strong>ï¼ˆ1ï¼‰webpack-dev-server/client/index.js</strong></p><p>é¦–å…ˆè¿™ä¸ªæ–‡ä»¶ç”¨äº<code>websocket</code>çš„ï¼Œå› ä¸º<code>websoket</code>æ˜¯åŒå‘é€šä¿¡ï¼Œå¦‚æœä¸äº†è§£<code>websocket</code>ï¼Œå»ºè®®ç®€å•äº†è§£ä¸€ä¸‹<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2017%2F05%2Fwebsocket.html %22https://www.ruanyifeng.com/blog/2017/05/websocket.html%22" target="_blank" rel="noopener">websocketé€Ÿæˆ</a>ã€‚æˆ‘ä»¬åœ¨ç¬¬ 1 æ­¥ <code>webpack-dev-server</code>åˆå§‹åŒ– çš„è¿‡ç¨‹ä¸­ï¼Œå¯åŠ¨çš„æ˜¯æœ¬åœ°æœåŠ¡ç«¯çš„<code>websocket</code>ã€‚é‚£å®¢æˆ·ç«¯ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„æµè§ˆå™¨ï¼Œæµè§ˆå™¨è¿˜æ²¡æœ‰å’ŒæœåŠ¡ç«¯é€šä¿¡çš„ä»£ç å‘¢ï¼Ÿæ€»ä¸èƒ½è®©å¼€å‘è€…å»å†™å§hhhhhhã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æŠŠ<code>websocket</code>å®¢æˆ·ç«¯é€šä¿¡ä»£ç å·å·å¡åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­ã€‚å®¢æˆ·ç«¯å…·ä½“çš„ä»£ç åé¢ä¼šåœ¨åˆé€‚çš„æ—¶æœºç»†è®²å“¦ã€‚</p><p><strong>ï¼ˆ2ï¼‰webpack/hot/dev-server.js</strong></p><p>è¿™ä¸ªæ–‡ä»¶ä¸»è¦æ˜¯ç”¨äºæ£€æŸ¥æ›´æ–°é€»è¾‘çš„ï¼Œè¿™é‡Œå¤§å®¶çŸ¥é“å°±å¥½ï¼Œä»£ç åé¢ä¼šåœ¨åˆé€‚çš„æ—¶æœºï¼ˆ<strong>ç¬¬5æ­¥</strong>ï¼‰ç»†è®²ã€‚</p><h3>3. ç›‘å¬webpackç¼–è¯‘ç»“æŸ</h3><p>ä¿®æ”¹å¥½å…¥å£é…ç½®åï¼Œåˆè°ƒç”¨äº†<code>setupHooks</code>æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥æ³¨å†Œç›‘å¬äº‹ä»¶çš„ï¼Œç›‘å¬æ¯æ¬¡<code>webpack</code>ç¼–è¯‘å®Œæˆã€‚</p><pre class="code-block"><code class="language-javascript">// node_modules/webpack-dev-server/lib/Server.js
// ç»‘å®šç›‘å¬äº‹ä»¶
setupHooks() {
    const {done} = compiler.hooks;
    // ç›‘å¬webpackçš„doneé’©å­ï¼Œtapableæä¾›çš„ç›‘å¬æ–¹æ³•
    done.tap(&#39;webpack-dev-server&#39;, (stats) =&gt; {
        this._sendStats(this.sockets, this.getStats(stats));
        this._stats = stats;
    });
};
</code></pre><p>å½“ç›‘å¬åˆ°ä¸€æ¬¡<code>webpack</code>ç¼–è¯‘ç»“æŸï¼Œå°±ä¼šè°ƒç”¨<code>_sendStats</code>æ–¹æ³•é€šè¿‡<code>websocket</code>ç»™æµè§ˆå™¨å‘é€é€šçŸ¥ï¼Œ<code>ok</code>å’Œ<code>hash</code>äº‹ä»¶ï¼Œè¿™æ ·æµè§ˆå™¨å°±å¯ä»¥æ‹¿åˆ°æœ€æ–°çš„<code>hash</code>å€¼äº†ï¼Œåšæ£€æŸ¥æ›´æ–°é€»è¾‘ã€‚</p><pre class="code-block"><code class="language-reasonml">// é€šè¿‡websoketç»™å®¢æˆ·ç«¯å‘æ¶ˆæ¯
_sendStats() {
    this.sockWrite(sockets, &#39;hash&#39;, stats.hash);
    this.sockWrite(sockets, &#39;ok&#39;);
}
</code></pre><h3>4. webpackç›‘å¬æ–‡ä»¶å˜åŒ–</h3><p>æ¯æ¬¡ä¿®æ”¹ä»£ç ï¼Œå°±ä¼šè§¦å‘ç¼–è¯‘ã€‚è¯´æ˜æˆ‘ä»¬è¿˜éœ€è¦ç›‘å¬æœ¬åœ°ä»£ç çš„å˜åŒ–ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>setupDevMiddleware</code>æ–¹æ³•å®ç°çš„ã€‚</p><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ‰§è¡Œäº†<code>webpack-dev-middleware</code>åº“ã€‚å¾ˆå¤šäººåˆ†ä¸æ¸…<code>webpack-dev-middleware</code>å’Œ<code>webpack-dev-server</code>çš„åŒºåˆ«ã€‚å…¶å®å°±æ˜¯å› ä¸º<code>webpack-dev-server</code>åªè´Ÿè´£å¯åŠ¨æœåŠ¡å’Œå‰ç½®å‡†å¤‡å·¥ä½œï¼Œæ‰€æœ‰æ–‡ä»¶ç›¸å…³çš„æ“ä½œéƒ½æŠ½ç¦»åˆ°<code>webpack-dev-middleware</code>åº“äº†ï¼Œä¸»è¦æ˜¯æœ¬åœ°æ–‡ä»¶çš„<strong>ç¼–è¯‘</strong>å’Œ<strong>è¾“å‡º</strong>ä»¥åŠ<strong>ç›‘å¬</strong>ï¼Œæ— éå°±æ˜¯èŒè´£çš„åˆ’åˆ†æ›´æ¸…æ™°äº†ã€‚</p><p>é‚£æˆ‘ä»¬æ¥çœ‹ä¸‹<code>webpack-dev-middleware</code>æºç é‡Œåšäº†ä»€ä¹ˆäº‹:</p><pre class="code-block"><code class="language-awk">// node_modules/webpack-dev-middleware/index.js
compiler.watch(options.watchOptions, (err) =&gt; {
    if (err) { /*é”™è¯¯å¤„ç†*/ }
});

// é€šè¿‡â€œmemory-fsâ€åº“å°†æ‰“åŒ…åçš„æ–‡ä»¶å†™å…¥å†…å­˜
setFs(context, compiler); 
</code></pre><p>ï¼ˆ1ï¼‰è°ƒç”¨äº†<code>compiler.watch</code>æ–¹æ³•ï¼Œåœ¨ç¬¬ 1 æ­¥ä¸­ä¹Ÿæåˆ°è¿‡ï¼Œ<code>compiler</code>çš„å¼ºå¤§ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦å°±åšäº† 2 ä»¶äº‹ï¼š</p><ul><li>é¦–å…ˆå¯¹æœ¬åœ°æ–‡ä»¶ä»£ç è¿›è¡Œç¼–è¯‘æ‰“åŒ…ï¼Œä¹Ÿå°±æ˜¯<code>webpack</code>çš„ä¸€ç³»åˆ—ç¼–è¯‘æµç¨‹ã€‚</li><li>å…¶æ¬¡ç¼–è¯‘ç»“æŸåï¼Œå¼€å¯å¯¹æœ¬åœ°æ–‡ä»¶çš„ç›‘å¬ï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°ç¼–è¯‘ï¼Œç¼–è¯‘å®Œæˆä¹‹åç»§ç»­ç›‘å¬ã€‚</li></ul><p>ä¸ºä»€ä¹ˆä»£ç çš„æ”¹åŠ¨ä¿å­˜ä¼šè‡ªåŠ¨ç¼–è¯‘ï¼Œé‡æ–°æ‰“åŒ…ï¼Ÿè¿™ä¸€ç³»åˆ—çš„é‡æ–°æ£€æµ‹ç¼–è¯‘å°±å½’åŠŸäº<code>compiler.watch</code>è¿™ä¸ªæ–¹æ³•äº†ã€‚ç›‘å¬æœ¬åœ°æ–‡ä»¶çš„å˜åŒ–ä¸»è¦æ˜¯é€šè¿‡<strong>æ–‡ä»¶çš„ç”Ÿæˆæ—¶é—´</strong>æ˜¯å¦æœ‰å˜åŒ–ï¼Œè¿™é‡Œå°±ä¸ç»†è®²äº†ã€‚</p><p>ï¼ˆ2ï¼‰æ‰§è¡Œ<code>setFs</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦ç›®çš„å°±æ˜¯å°†ç¼–è¯‘åçš„æ–‡ä»¶æ‰“åŒ…åˆ°å†…å­˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç°<code>dist</code>ç›®å½•æ²¡æœ‰æ‰“åŒ…åçš„ä»£ç ï¼Œå› ä¸ºéƒ½åœ¨å†…å­˜ä¸­ã€‚åŸå› å°±åœ¨äºè®¿é—®å†…å­˜ä¸­çš„ä»£ç æ¯”è®¿é—®æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æ›´å¿«ï¼Œè€Œä¸”ä¹Ÿå‡å°‘äº†ä»£ç å†™å…¥æ–‡ä»¶çš„å¼€é”€ï¼Œè¿™ä¸€åˆ‡éƒ½å½’åŠŸäº<code>memory-fs</code>ã€‚</p><h3>5. æµè§ˆå™¨æ¥æ”¶åˆ°çƒ­æ›´æ–°çš„é€šçŸ¥</h3><p>æˆ‘ä»¬å·²ç»å¯ä»¥ç›‘å¬åˆ°æ–‡ä»¶çš„å˜åŒ–äº†ï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œå°±è§¦å‘é‡æ–°ç¼–è¯‘ã€‚åŒæ—¶è¿˜ç›‘å¬äº†æ¯æ¬¡ç¼–è¯‘ç»“æŸçš„äº‹ä»¶ã€‚å½“ç›‘å¬åˆ°ä¸€æ¬¡<code>webpack</code>ç¼–è¯‘ç»“æŸï¼Œ<code>_sendStats</code>æ–¹æ³•å°±é€šè¿‡<code>websoket</code>ç»™æµè§ˆå™¨å‘é€é€šçŸ¥ï¼Œæ£€æŸ¥ä¸‹æ˜¯å¦éœ€è¦çƒ­æ›´æ–°ã€‚ä¸‹é¢é‡ç‚¹è®²çš„å°±æ˜¯<code>_sendStats</code>æ–¹æ³•ä¸­çš„<code>ok</code>å’Œ<code>hash</code>äº‹ä»¶éƒ½åšäº†ä»€ä¹ˆã€‚</p><p>é‚£æµè§ˆå™¨æ˜¯å¦‚ä½•æ¥æ”¶åˆ°<code>websocket</code>çš„æ¶ˆæ¯å‘¢ï¼Ÿå›å¿†ä¸‹ç¬¬ 2 æ­¥éª¤å¢åŠ çš„å…¥å£æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯<code>websocket</code>å®¢æˆ·ç«¯ä»£ç ã€‚</p><pre class="code-block"><code>&#39;xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080&#39;
</code></pre><p>è¿™ä¸ªæ–‡ä»¶çš„ä»£ç ä¼šè¢«æ‰“åŒ…åˆ°<code>bundle.js</code>ä¸­ï¼Œè¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚æ¥çœ‹ä¸‹è¿™ä¸ªæ–‡ä»¶çš„æ ¸å¿ƒä»£ç å§ã€‚</p><pre class="code-block"><code class="language-js">// webpack-dev-server/client/index.js
var socket = require(&#39;./socket&#39;);
var onSocketMessage = {
    hash: function hash(_hash) {
        // æ›´æ–°currentHashå€¼
        status.currentHash = _hash;
    },
    ok: function ok() {
        sendMessage(&#39;Ok&#39;);
        // è¿›è¡Œæ›´æ–°æ£€æŸ¥ç­‰æ“ä½œ
        reloadApp(options, status);
    },
};
// è¿æ¥æœåŠ¡åœ°å€socketUrlï¼Œ?http://localhost:8080ï¼Œæœ¬åœ°æœåŠ¡åœ°å€
socket(socketUrl, onSocketMessage);

function reloadApp() {
	if (hot) {
        log.info(&#39;[WDS] App hot update...&#39;);

        // hotEmitterå…¶å®å°±æ˜¯EventEmitterçš„å®ä¾‹
        var hotEmitter = require(&#39;webpack/hot/emitter&#39;);
        hotEmitter.emit(&#39;webpackHotUpdate&#39;, currentHash);
    }
}
</code></pre><p><code>socket</code>æ–¹æ³•å»ºç«‹äº†<code>websocket</code>å’ŒæœåŠ¡ç«¯çš„è¿æ¥ï¼Œå¹¶æ³¨å†Œäº† 2 ä¸ªç›‘å¬äº‹ä»¶ã€‚</p><ul><li><code>hash</code>äº‹ä»¶ï¼Œæ›´æ–°æœ€æ–°ä¸€æ¬¡æ‰“åŒ…åçš„<code>hash</code>å€¼ã€‚</li><li><code>ok</code>äº‹ä»¶ï¼Œè¿›è¡Œçƒ­æ›´æ–°æ£€æŸ¥ã€‚</li></ul><p>çƒ­æ›´æ–°æ£€æŸ¥äº‹ä»¶æ˜¯è°ƒç”¨<code>reloadApp</code>æ–¹æ³•ã€‚æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•åˆåˆ©ç”¨<code>node.js</code>çš„<code>EventEmitter</code>ï¼Œå‘å‡º<code>webpackHotUpdate</code>æ¶ˆæ¯ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥è¿›è¡Œæ£€æŸ¥æ›´æ–°å‘¢ï¼Ÿ</p><p>ä¸ªäººç†è§£å°±æ˜¯ä¸ºäº†æ›´å¥½çš„ç»´æŠ¤ä»£ç ï¼Œä»¥åŠèŒè´£åˆ’åˆ†çš„æ›´æ˜ç¡®ã€‚<code>websocket</code>ä»…ä»…ç”¨äºå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰å’ŒæœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ã€‚è€ŒçœŸæ­£åšäº‹æƒ…çš„æ´»è¿˜æ˜¯äº¤å›ç»™äº†<code>webpack</code>ã€‚</p><p>é‚£<code>webpack</code>æ€ä¹ˆåšçš„å‘¢ï¼Ÿå†æ¥å›å¿†ä¸‹ç¬¬ 2 æ­¥ã€‚å…¥å£æ–‡ä»¶è¿˜æœ‰ä¸€ä¸ªæ–‡ä»¶æ²¡æœ‰è®²åˆ°ï¼Œå°±æ˜¯ï¼š</p><pre class="code-block"><code>&#39;xxx/node_modules/webpack/hot/dev-server.js&#39;
</code></pre><p>è¿™ä¸ªæ–‡ä»¶çš„ä»£ç åŒæ ·ä¼šè¢«æ‰“åŒ…åˆ°<code>bundle.js</code>ä¸­ï¼Œè¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚è¿™ä¸ªæ–‡ä»¶åšäº†ä»€ä¹ˆå°±æ˜¾è€Œæ˜“è§äº†å§ï¼å…ˆç„ä¸€çœ¼ä»£ç ï¼š</p><pre class="code-block"><code class="language-javascript">// node_modules/webpack/hot/dev-server.js
var check = function check() {
    module.hot.check(true)
        .then(function(updatedModules) {
            // å®¹é”™ï¼Œç›´æ¥åˆ·æ–°é¡µé¢
            if (!updatedModules) {
                window.location.reload();
                return;
            }

            // çƒ­æ›´æ–°ç»“æŸï¼Œæ‰“å°ä¿¡æ¯
            if (upToDate()) {
                log(&quot;info&quot;, &quot;[HMR] App is up to date.&quot;);
            }
    })
        .catch(function(err) {
            window.location.reload();
        });
};

var hotEmitter = require(&quot;./emitter&quot;);
hotEmitter.on(&quot;webpackHotUpdate&quot;, function(currentHash) {
    lastHash = currentHash;
    check();
});
</code></pre><p>è¿™é‡Œ<code>webpack</code>ç›‘å¬åˆ°äº†<code>webpackHotUpdate</code>äº‹ä»¶ï¼Œå¹¶è·å–æœ€æ–°äº†æœ€æ–°çš„<code>hash</code>å€¼ï¼Œç„¶åç»ˆäºè¿›è¡Œæ£€æŸ¥æ›´æ–°äº†ã€‚æ£€æŸ¥æ›´æ–°å‘¢è°ƒç”¨çš„æ˜¯<code>module.hot.check</code>æ–¹æ³•ã€‚é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œ<code>module.hot.check</code>åˆæ˜¯å“ªé‡Œå†’å‡ºæ¥äº†çš„ï¼ç­”æ¡ˆæ˜¯<code>HotModuleReplacementPlugin</code>æå¾—é¬¼ã€‚è¿™é‡Œç•™ä¸ªç–‘é—®ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚</p><h3>6. HotModuleReplacementPlugin</h3><p>å‰é¢å¥½åƒä¸€ç›´æ˜¯<code>webpack-dev-server</code>åšçš„äº‹ï¼Œé‚£<code>HotModuleReplacementPlugin</code>åœ¨çƒ­æ›´æ–°è¿‡ç¨‹ä¸­åˆåšäº†ä»€ä¹ˆä¼Ÿå¤§çš„äº‹ä¸šå‘¢ï¼Ÿ</p><p>é¦–å…ˆä½ å¯ä»¥å¯¹æ¯”ä¸‹ï¼Œé…ç½®çƒ­æ›´æ–°å’Œä¸é…ç½®æ—¶<code>bundle.js</code>çš„åŒºåˆ«ã€‚å†…å­˜ä¸­çœ‹ä¸åˆ°ï¼Ÿç›´æ¥æ‰§è¡Œ<code>webpack</code>å‘½ä»¤å°±å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„<code>bundle.js</code>æ–‡ä»¶å•¦ã€‚ä¸è¦ç”¨<code>webpack-dev-server</code>å¯åŠ¨å°±å¥½äº†ã€‚</p><p>ï¼ˆ1ï¼‰æ²¡æœ‰é…ç½®çš„ã€‚</p><p><img alt="" src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec0c9e8fd12349~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" /></p><p>ï¼ˆ2ï¼‰é…ç½®äº†<code>HotModuleReplacementPlugin</code>æˆ–<code>--hot</code>çš„ã€‚</p><p><img alt="" src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec0c90092fa0ac~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" /></p><p>å“¦~ æˆ‘ä»¬å‘ç°<code>moudle</code>æ–°å¢äº†ä¸€ä¸ªå±æ€§ä¸º<code>hot</code>ï¼Œå†çœ‹<code>hotCreateModule</code>æ–¹æ³•ã€‚ è¿™ä¸å°±æ‰¾åˆ°<code>module.hot.check</code>æ˜¯å“ªé‡Œå†’å‡ºæ¥çš„ã€‚</p><p><img alt="" src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec0dc36018973f~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" /></p><p>ç»è¿‡å¯¹æ¯”æ‰“åŒ…åçš„æ–‡ä»¶ï¼Œ<code>__webpack_require__</code>ä¸­çš„<code>moudle</code>ä»¥åŠä»£ç è¡Œæ•°çš„ä¸åŒã€‚æˆ‘ä»¬éƒ½å¯ä»¥å‘ç°<code>HotModuleReplacementPlugin</code>åŸæ¥ä¹Ÿæ˜¯é»˜é»˜çš„å¡äº†å¾ˆå¤šä»£ç åˆ°<code>bundle.js</code>ä¸­å‘€ã€‚è¿™å’Œç¬¬ 2 æ­¥éª¤å¾ˆæ˜¯ç›¸ä¼¼å“¦ï¼ä¸ºä»€ä¹ˆï¼Œå› ä¸ºæ£€æŸ¥æ›´æ–°æ˜¯åœ¨æµè§ˆå™¨ä¸­æ“ä½œå‘€ã€‚è¿™äº›ä»£ç å¿…é¡»åœ¨è¿è¡Œæ—¶çš„ç¯å¢ƒã€‚</p><p>ä½ ä¹Ÿå¯ä»¥ç›´æ¥çœ‹æµè§ˆå™¨<code>Sources</code>ä¸‹çš„ä»£ç ï¼Œä¼šå‘ç°<code>webpack</code>å’Œ<code>plugin</code>å·å·åŠ çš„ä»£ç éƒ½åœ¨å“¦ã€‚åœ¨è¿™é‡Œè°ƒè¯•ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚</p><p><img alt="" src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec0d4634af2b3c~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" /></p><p><code>HotModuleReplacementPlugin</code>å¦‚ä½•åšåˆ°çš„ï¼Ÿè¿™é‡Œæˆ‘å°±ä¸è®²äº†ï¼Œå› ä¸ºè¿™éœ€è¦ä½ å¯¹<code>tapable</code>ä»¥åŠ<code>plugin</code>æœºåˆ¶æœ‰ä¸€å®šäº†è§£ï¼Œå¯ä»¥çœ‹ä¸‹æˆ‘å†™çš„æ–‡ç« <a href="https://juejin.cn/post/6844904004435050503" target="_blank" rel="noopener">Webpackæ’ä»¶æœºåˆ¶ä¹‹Tapable-æºç è§£æ</a>ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©è·³è¿‡ï¼Œåªå…³å¿ƒçƒ­æ›´æ–°æœºåˆ¶å³å¯ï¼Œæ¯•ç«Ÿä¿¡æ¯é‡å¤ªå¤§ã€‚</p><h3>7. moudle.hot.check å¼€å§‹çƒ­æ›´æ–°</h3><p>é€šè¿‡ç¬¬ 6 æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“<code>moudle.hot.check</code>æ–¹æ³•æ˜¯å¦‚ä½•æ¥çš„å•¦ã€‚é‚£éƒ½åšäº†ä»€ä¹ˆï¼Ÿä¹‹åçš„æºç éƒ½æ˜¯<code>HotModuleReplacementPlugin</code>å¡å…¥åˆ°<code>bundle.js</code>ä¸­çš„å“¦ï¼Œæˆ‘å°±ä¸å†™æ–‡ä»¶è·¯å¾„äº†ã€‚</p><ul><li>åˆ©ç”¨ä¸Šä¸€æ¬¡ä¿å­˜çš„<code>hash</code>å€¼ï¼Œè°ƒç”¨<code>hotDownloadManifest</code>å‘é€<code>xxx/hash.hot-update.json</code>çš„<code>ajax</code>è¯·æ±‚ï¼›</li><li>è¯·æ±‚ç»“æœè·å–çƒ­æ›´æ–°æ¨¡å—ï¼Œä»¥åŠä¸‹æ¬¡çƒ­æ›´æ–°çš„<code>Hash</code> æ ‡è¯†ï¼Œå¹¶è¿›å…¥çƒ­æ›´æ–°å‡†å¤‡é˜¶æ®µã€‚</li></ul><pre class="code-block"><code class="language-abnf">hotAvailableFilesMap = update.c; // éœ€è¦æ›´æ–°çš„æ–‡ä»¶
hotUpdateNewHash = update.h; // æ›´æ–°ä¸‹æ¬¡çƒ­æ›´æ–°hashå€¼
hotSetStatus(&quot;prepare&quot;); // è¿›å…¥çƒ­æ›´æ–°å‡†å¤‡çŠ¶æ€
</code></pre><ul><li>è°ƒç”¨<code>hotDownloadUpdateChunk</code>å‘é€<code>xxx/hash.hot-update.js</code> è¯·æ±‚ï¼Œé€šè¿‡<code>JSONP</code>æ–¹å¼ã€‚</li></ul><pre class="code-block"><code class="language-javascript">function hotDownloadUpdateChunk(chunkId) {
    var script = document.createElement(&quot;script&quot;);
    script.charset = &quot;utf-8&quot;;
    script.src = __webpack_require__.p + &quot;&quot; + chunkId + &quot;.&quot; + hotCurrentHash + &quot;.hot-update.js&quot;;
    if (null) script.crossOrigin = null;
    document.head.appendChild(script);
 }
</code></pre><p>è¿™ä¸ªå‡½æ•°ä½“ä¸ºä»€ä¹ˆè¦å•ç‹¬æ‹¿å‡ºæ¥ï¼Œå› ä¸ºè¿™é‡Œè¦è§£é‡Šä¸‹ä¸ºä»€ä¹ˆä½¿ç”¨<code>JSONP</code>è·å–æœ€æ–°ä»£ç ï¼Ÿä¸»è¦æ˜¯å› ä¸º<code>JSONP</code>è·å–çš„ä»£ç å¯ä»¥ç›´æ¥æ‰§è¡Œã€‚ä¸ºä»€ä¹ˆè¦ç›´æ¥æ‰§è¡Œï¼Ÿæˆ‘ä»¬æ¥å›å¿†ä¸‹<code>/hash.hot-update.js</code>çš„ä»£ç æ ¼å¼æ˜¯æ€ä¹ˆæ ·çš„ã€‚</p><p><img alt="" src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec04316d6ac5e3~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" /></p><p>å¯ä»¥å‘ç°ï¼Œæ–°ç¼–è¯‘åçš„ä»£ç æ˜¯åœ¨ä¸€ä¸ª<code>webpackHotUpdate</code>å‡½æ•°ä½“å†…éƒ¨çš„ã€‚ä¹Ÿå°±æ˜¯è¦ç«‹å³æ‰§è¡Œ<code>webpackHotUpdate</code>è¿™ä¸ªæ–¹æ³•ã€‚</p><p>å†çœ‹ä¸‹<code>webpackHotUpdate</code>è¿™ä¸ªæ–¹æ³•ã€‚</p><pre class="code-block"><code class="language-ada">window[&quot;webpackHotUpdate&quot;] = function (chunkId, moreModules) {
    hotAddUpdateChunk(chunkId, moreModules);
} ;
</code></pre><ul><li><code>hotAddUpdateChunk</code>æ–¹æ³•ä¼šæŠŠæ›´æ–°çš„æ¨¡å—<code>moreModules</code>èµ‹å€¼ç»™å…¨å±€å…¨é‡<code>hotUpdate</code>ã€‚</li><li><code>hotUpdateDownloaded</code>æ–¹æ³•ä¼šè°ƒç”¨<code>hotApply</code>è¿›è¡Œä»£ç çš„æ›¿æ¢ã€‚</li></ul><pre class="code-block"><code class="language-reasonml">function hotAddUpdateChunk(chunkId, moreModules) {
    // æ›´æ–°çš„æ¨¡å—moreModulesèµ‹å€¼ç»™å…¨å±€å…¨é‡hotUpdate
    for (var moduleId in moreModules) {
        if (Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {
	    hotUpdate[moduleId] = moreModules[moduleId];
        }
    }
    // è°ƒç”¨hotApplyè¿›è¡Œæ¨¡å—çš„æ›¿æ¢
    hotUpdateDownloaded();
}
</code></pre><h3>8. hotApply çƒ­æ›´æ–°æ¨¡å—æ›¿æ¢</h3><p>çƒ­æ›´æ–°çš„æ ¸å¿ƒé€»è¾‘å°±åœ¨<code>hotApply</code>æ–¹æ³•äº†ã€‚ <code>hotApply</code>ä»£ç æœ‰å°†è¿‘ 400 è¡Œï¼Œè¿˜æ˜¯æŒ‘é‡ç‚¹è®²äº†ï¼Œçœ‹å“­ğŸ˜­</p><h4>â‘ åˆ é™¤è¿‡æœŸçš„æ¨¡å—ï¼Œå°±æ˜¯éœ€è¦æ›¿æ¢çš„æ¨¡å—</h4><p>é€šè¿‡<code>hotUpdate</code>å¯ä»¥æ‰¾åˆ°æ—§æ¨¡å—</p><pre class="code-block"><code class="language-cpp">var queue = outdatedModules.slice();
while (queue.length &gt; 0) {
    moduleId = queue.pop();
    // ä»ç¼“å­˜ä¸­åˆ é™¤è¿‡æœŸçš„æ¨¡å—
    module = installedModules[moduleId];
    // åˆ é™¤è¿‡æœŸçš„ä¾èµ–
    delete outdatedDependencies[moduleId];

    // å­˜å‚¨äº†è¢«åˆ æ‰çš„æ¨¡å—idï¼Œä¾¿äºæ›´æ–°ä»£ç 
    outdatedSelfAcceptedModules.push({
        module: moduleId
    });
}
</code></pre><h4>â‘¡å°†æ–°çš„æ¨¡å—æ·»åŠ åˆ° modules ä¸­</h4><pre class="code-block"><code class="language-inform7">appliedUpdate[moduleId] = hotUpdate[moduleId];
for (moduleId in appliedUpdate) {
    if (Object.prototype.hasOwnProperty.call(appliedUpdate, moduleId)) {
        modules[moduleId] = appliedUpdate[moduleId];
    }
}
</code></pre><h4>â‘¢é€šè¿‡\_\_webpack\_require\_\_æ‰§è¡Œç›¸å…³æ¨¡å—çš„ä»£ç </h4><pre class="code-block"><code class="language-abnf">for (i = 0; i &lt; outdatedSelfAcceptedModules.length; i++) {
    var item = outdatedSelfAcceptedModules[i];
    moduleId = item.module;
    try {
        // æ‰§è¡Œæœ€æ–°çš„ä»£ç 
        __webpack_require__(moduleId);
    } catch (err) {
        // ...å®¹é”™å¤„ç†
    }
}

</code></pre><p><code>hotApply</code>çš„ç¡®æ¯”è¾ƒå¤æ‚ï¼ŒçŸ¥é“å¤§æ¦‚æµç¨‹å°±å¥½äº†ï¼Œè¿™ä¸€å°èŠ‚ï¼Œè¦æ±‚ä½ å¯¹webpackæ‰“åŒ…åçš„æ–‡ä»¶å¦‚ä½•æ‰§è¡Œçš„æœ‰ä¸€äº›äº†è§£ï¼Œå¤§å®¶å¯ä»¥è‡ªå»çœ‹ä¸‹ã€‚</p><h3>æ€»ç»“</h3><p>è¿˜æ˜¯ä»¥é˜…è¯»æºç çš„å½¢å¼ç”»çš„å›¾ï¼Œâ‘ -â‘£çš„å°æ ‡è®°ï¼Œæ˜¯æ–‡ä»¶å‘ç”Ÿå˜åŒ–çš„ä¸€ä¸ªæµç¨‹ã€‚</p><p><img alt="" src="https://foruda.gitee.com/images/1681014860649655814/ea9d055f_7819612.png" /></p><h3>å‚è€ƒæ–‡æ¡£</h3><ul><li><a href="https://juejin.cn/post/6844904008432222215" target="_blank" rel="noopener">è½»æ¾ç†è§£webpackçƒ­æ›´æ–°åŸç†</a></li><li><a href="https://www.ruanyifeng.com/blog/2017/05/websocket.html" target="_blank" rel="noopener">websocketåŸºç¡€çŸ¥è¯†äº†è§£</a></li><li><a href="https://juejin.cn/post/6844904004435050503" target="_blank" rel="noopener">tapable: Webpackæ’ä»¶æœºåˆ¶ä¹‹Tapable-æºç è§£æ</a></li><li><a href="https://github.com/Jocs/jocs.github.io/issues/15" target="_blank" rel="noopener">Webpack Hot Module Replacement çš„åŸç†è§£æ</a></li><li><a href="https://juejin.cn/post/6844903953092591630" target="_blank" rel="noopener">çœ‹å®Œè¿™ç¯‡ï¼Œé¢è¯•å†ä¹Ÿä¸æ€•è¢«é—® Webpack çƒ­æ›´æ–°</a></li><li><a href="https://zhuanlan.zhihu.com/p/30669007" target="_blank" rel="noopener">Webpack HMR åŸç†è§£æ</a></li></ul><h2>Comments / Answers</h2><hr /><p><strong>yanlele</strong> at 2023-08-02T15:16:08Z</p><p>æ·»åŠ æ–‡ç« ï¼š https://juejin.cn/post/7155354834877546532</p><hr /><p><strong>yanlele</strong> at 2023-10-05T03:18:27Z</p><p>å‚è€ƒæ–‡æ¡£ï¼š https://juejin.cn/post/7176963906844246074</p></article>
  </main>
  <footer class="site-footer">Â© é¢è¯•é¢˜åˆ·é¢˜ Â· ç”±æœ¬åœ°é™æ€é¡µé¢ç”Ÿæˆ</footer>
</body>
</html>