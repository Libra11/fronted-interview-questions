<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>文件上传和上传文件解析的原理是啥？ - 面试题刷题</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <meta name="description" content="&lt;h3&gt;前端如何上传图片等文件&lt;/h3&gt;&lt;p&gt;在前端上传图片或其他文件字段，一般使用 HTML 中的 &lt;code&gt;&amp;lt;input&amp;gt;&lt;/code&gt; 元素，并设置 &lt;code&gt;type=&amp;quot;file&amp;quot;&lt;/code&gt;，这样就可以让用户选择本地的文件进行上传。" />
  <link rel="icon" href="../assets/favicon.svg" />
  <style>.content a{color:var(--brand);} .content img{max-width:100%;}</style>
  
  <!-- Open Graph -->
  <meta property="og:title" content="文件上传和上传文件解析的原理是啥？" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="&lt;h3&gt;前端如何上传图片等文件&lt;/h3&gt;&lt;p&gt;在前端上传图片或其他文件字段，一般使用 HTML 中的 &lt;code&gt;&amp;lt;input&amp;gt;&lt;/code&gt; 元素，并设置 &lt;code&gt;type=&amp;quot;file&amp;quot;&lt;/code&gt;，这样就可以让用户选择本地的文件进行上传。&lt;/p&gt;&lt;p&gt;例如：&lt;/p&gt;&lt;pre class=&quot;code-block&quot;&gt;&lt;code class=&quot;language-" />
  <meta property="og:locale" content="zh_CN" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="../index.html">面试题刷题</a>
      <nav class="nav">
        <a href="../index.html">首页</a>
        <a href="../index.html#categories">分类</a>
        <a href="https://github.com/pro-collection/interview-question/issues/170" target="_blank" rel="noopener">原始链接</a>
      </nav>
    </div>
  </header>
  <main class="container article">
    <div class="article-head">
      <a class="back" href="../index.html">← 返回列表</a>
      <h1>文件上传和上传文件解析的原理是啥？</h1>
      <div class="subtitle">浏览器 · 网络 · 浏览器</div>
      <div class="meta">创建：2023-03-26T07:57:45Z · 更新：2023-03-26T07:57:46Z</div>
    </div>
    <article class="content markdown-body"><h3>前端如何上传图片等文件</h3><p>在前端上传图片或其他文件字段，一般使用 HTML 中的 <code>&lt;input&gt;</code> 元素，并设置 <code>type=&quot;file&quot;</code>，这样就可以让用户选择本地的文件进行上传。</p><p>例如：</p><pre class="code-block"><code class="language-html">htmlCopy code&lt;form enctype=&quot;multipart/form-data&quot;&gt;
  &lt;input type=&quot;file&quot; name=&quot;image&quot; accept=&quot;image/*&quot;&gt;
  &lt;input type=&quot;submit&quot; value=&quot;上传&quot;&gt;
&lt;/form&gt;
</code></pre><p>在这个例子中，<code>&lt;form&gt;</code> 元素的 <code>enctype</code> 属性设置为 <code>multipart/form-data</code>，这样就可以将文件作为二进制数据进行上传。</p><p>当用户选择了本地的文件后，提交表单时就会将文件作为 <code>FormData</code> 对象的一部分进行发送。在 JavaScript 中，可以通过 <code>FormData</code> 构造函数来创建一个 <code>FormData</code> 对象，并使用 <code>append()</code> 方法向其中添加上传的文件数据。例如：</p><pre class="code-block"><code class="language-javascript">const formData = new FormData();
const fileInput = document.querySelector(&#39;input[type=&quot;file&quot;]&#39;);
formData.append(&#39;image&#39;, fileInput.files[0]);
</code></pre><p>这样就可以将文件数据添加到 <code>formData</code> 对象中，然后使用 <code>fetch()</code> 方法或其他方式将其发送到后端进行处理。</p><p>需要注意的是，由于安全原因，浏览器限制了用户上传文件的大小和类型。可以使用 <code>accept</code> 属性来限制文件的类型，例如 <code>accept=&quot;image/*&quot;</code> 表示只允许上传图片类型的文件。可以使用 <code>multiple</code> 属性来允许用户选择多个文件进行上传。同时，还需要在后端对上传的文件进行处理和验证，以确保安全性和正确性。</p><h3>后端如何解析？koa 为例</h3><p>在 Koa 中解析上传的文件需要使用一个叫做 <code>koa-body</code> 的中间件，它可以自动将 <code>multipart/form-data</code> 格式的请求体解析成 JavaScript 对象，从而获取到上传的文件和其他表单数据。</p><p>以下是一个使用 <code>koa-body</code> 中间件解析上传文件的例子：</p><pre class="code-block"><code class="language-javascript">const Koa = require(&#39;koa&#39;);
const koaBody = require(&#39;koa-body&#39;);

const app = new Koa();

// 注册 koa-body 中间件
app.use(koaBody({
  multipart: true, // 支持上传文件
}));

// 处理上传文件的请求
app.use(async (ctx) =&gt; {
  const { files, fields } = ctx.request.body; // 获取上传的文件和其他表单数据
  const file = files &amp;&amp; files.image; // 获取上传的名为 image 的文件

  if (file) {
    console.log(`Received file: ${file.name}, type: ${file.type}, size: ${file.size}`);
    // 处理上传的文件
  } else {
    console.log(&#39;No file received&#39;);
  }

  // 返回响应
  ctx.body = &#39;Upload success&#39;;
});

app.listen(3000);
</code></pre><p>在上述代码中，使用 <code>koa-body</code> 中间件注册了一个解析请求体的函数，并在请求处理函数中获取到了上传的文件和其他表单数据。其中，<code>files</code> 对象包含了所有上传的文件，<code>fields</code> 对象包含了所有非文件类型的表单数据。</p><p>可以根据实际需要从 <code>files</code> 对象中获取到需要处理的文件，例如上面的例子中使用了 <code>files.image</code> 来获取名为 <code>image</code> 的上传文件。可以使用上传文件的属性，如 <code>name</code>、<code>type</code> 和 <code>size</code> 来获取文件的信息，并进行处理。最后返回响应，表示上传成功。</p><p>需要注意的是，<code>koa-body</code> 中间件需要设置 <code>multipart: true</code> 才能支持上传文件。另外，在处理上传文件时需要注意安全性和正确性，可以使用第三方的文件上传处理库来进行处理。</p><h3>解析上传文件的原理是啥？</h3><p>在 HTTP 协议中，上传文件的请求通常使用 <code>multipart/form-data</code> 格式的请求体。这种格式的请求体由多个部分组成，每个部分以一个 boundary 字符串作为分隔符，每个部分都代表一个字段或一个文件。</p><p>对于一个上传文件的请求，浏览器会将请求体按照 <code>multipart/form-data</code> 格式构造，其中每个部分都有一些描述信息和内容，例如文件名、文件类型、文件大小、内容等。</p><p>服务器端需要对这些部分进行解析，提取出所需要的信息。常见的解析方式有两种：</p><ol><li>手动解析：根据 <code>multipart/form-data</code> 格式的规范，按照 boundary 字符串将请求体切分为多个部分，然后解析每个部分的头部和内容，提取出文件名、文件类型、文件大小等信息。这种方式比较麻烦，需要手动处理较多的细节，容易出错。</li></ol><ol><li>使用第三方库：可以使用第三方的解析库，如 <code>multer</code>、<code>formidable</code>、<code>busboy</code> 等，来方便地解析 <code>multipart/form-data</code> 格式的请求体。这些库通常会将解析出的信息存储到一个对象中，方便进一步处理。</li></ol><p>在 Node.js 中，使用 <code>http</code> 模块自己实现 <code>multipart/form-data</code> 的解析比较麻烦，常见的做法是使用第三方库来解析上传文件，例如在 Koa 中使用 <code>koa-body</code> 中间件就可以方便地处理上传文件。</p></article>
  </main>
  <footer class="site-footer">© 面试题刷题 · 由本地静态页面生成</footer>
</body>
</html>